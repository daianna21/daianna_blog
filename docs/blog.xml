<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Daianna Gonzalez-Padilla</title>
<link>https://daianna21.github.io/daianna_blog/blog.html</link>
<atom:link href="https://daianna21.github.io/daianna_blog/blog.xml" rel="self" type="application/rss+xml"/>
<description>Daianna&#39;s personal scientific blog</description>
<generator>quarto-1.4.555</generator>
<lastBuildDate>Thu, 12 Dec 2024 00:00:00 GMT</lastBuildDate>
<item>
  <title>What comes first: count normalization or gene/sample filtering?</title>
  <dc:creator>Daianna Gonzalez-Padilla</dc:creator>
  <link>https://daianna21.github.io/daianna_blog/posts/2024-01-20_Filtering_and_Normalization/</link>
  <description><![CDATA[ 




<p>⚠️ This page is under development.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>One of my biggest questions while analyzing RNA-seq data has always been if I should first filter lowly-expressed genes and poor-quality samples and then normalize raw counts, or in what order these steps should be executed. Is there an order to follow irrespective of the filtering and normalization methods used? Does the order actually matter?</p>
<p>As you can imagine, if I’m writting this post is because I haven’t found a clear answer to all these questions. In my search I have gained more doubts than answers, but I have realized this is not an unaddressed issue but a hard one to close. With this post demonstrations I can finally say the order does matter, but it depends on the methodologies applied for filtering and normalizing.</p>
<p>In this post I will show the implications of the ordering of filtering and normalization steps, depending on the methods and metrics used for these analyses, with special attention to the TMM normalization method. I will offer warnings and practical recommendations for you to proceed with your analysis without racking you brain about it.</p>
</section>
<section id="what-youll-learn-here" class="level1">
<h1>What you’ll learn here</h1>
</section>
<section id="an-example-data-set" class="level1">
<h1>An example data set</h1>
<p>Using <a href="https://rna.recount.bio"><em>recount3</em></a> <span class="citation" data-cites="leonardocollado-torres2020 wilks2021a">(<strong>leonardocollado-torres2020?</strong>; <strong>wilks2021a?</strong>)</span> we will download data from a study (<a href="10.1016/j.chembiol.2019.05.005">Marc Hafner et al., 2019</a>; SRA ID: <code>SRP107565</code>) where 216 bulk samples were sequenced to examine the transcriptomic changes induced by 3 drugs for treating breast cancer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recount3)</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Download all available projects in human in recount3</span></span>
<span id="cb1-4">human_projects <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">available_projects</span>()</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Download gene expression data and metadata from SRP107565 study</span></span>
<span id="cb1-7">proj_info <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(</span>
<span id="cb1-8">    human_projects,</span>
<span id="cb1-9">    project <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SRP107565"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> project_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_sources"</span>,</span>
<span id="cb1-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recount3_url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://sciserver.org/public-data/recount3/data"</span></span>
<span id="cb1-11">)</span>
<span id="cb1-12"></span>
<span id="cb1-13">proj_info</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    project organism file_source     project_home project_type n_samples
1 SRP107565    human         sra data_sources/sra data_sources       216</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Create RangedSummarizedExperiment object to handle RNA-seq and sample data </span></span>
<span id="cb3-2">rse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_rse</span>(proj_info)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Gene expression data in assay(rse): for first 5 genes and 5 samples</span></span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assay</span>(rse)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  SRR5579425 SRR5579426 SRR5579433 SRR5579434 SRR5579435
ENSG00000278704.1          0          0          0          0          0
ENSG00000277400.1          0          0          0          0          0
ENSG00000274847.1          0          0          0          0          0
ENSG00000277428.1          0          0          0          0          0
ENSG00000276256.1          0          0          0          0          0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Sample metadata in colData(rse): for first 6 samples and 3 variables</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colData</span>(rse)[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 3 columns
             rail_id external_id       study
           &lt;integer&gt; &lt;character&gt; &lt;character&gt;
SRR5579425   1000031  SRR5579425   SRP107565
SRR5579426   1000045  SRR5579426   SRP107565
SRR5579433   1000255  SRR5579433   SRP107565
SRR5579434   1000270  SRR5579434   SRP107565
SRR5579435   1000286  SRR5579435   SRP107565
SRR5579436   1000301  SRR5579436   SRP107565</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Gene data in rowData(rse): for first 6 genes and 3 variables</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowData</span>(rse)[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 3 columns
                    source     type bp_length
                  &lt;factor&gt; &lt;factor&gt; &lt;numeric&gt;
ENSG00000278704.1  ENSEMBL     gene      2237
ENSG00000277400.1  ENSEMBL     gene      2179
ENSG00000274847.1  ENSEMBL     gene      1599
ENSG00000277428.1  ENSEMBL     gene       101
ENSG00000276256.1  ENSEMBL     gene      2195
ENSG00000278198.1  ENSEMBL     gene      1468</code></pre>
</div>
</div>
<p>In the <a href="https://www.bioconductor.org/packages/devel/bioc/vignettes/SummarizedExperiment/inst/doc/SummarizedExperiment.html"><em>RangedSummarizedExperiment</em></a> <span class="citation" data-cites="martinmorgan2017 huber2015">(<strong>martinmorgan2017?</strong>; <strong>huber2015?</strong>)</span> object (<code>rse</code>) there are raw expression data for 63,856 genes across the 216 samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(rse)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 63856   216</code></pre>
</div>
</div>
</section>
<section id="normalization" class="level1">
<h1>Normalization</h1>
<p>In order to compare gene expression measures between samples of two or more experimental groups, normalization of raw counts is required to correct for between-sample technical differences, such as sequencing depth. Various normalization methods have been proposed, each relying on specific methodological assumptions [].</p>
<p>One of the most commonly adopted schemes is the trimmed mean of M values method.</p>
<section id="normalization-methods-on-rna-seq" class="level4">
<h4 class="anchored" data-anchor-id="normalization-methods-on-rna-seq"><strong>Normalization Methods on RNA-Seq:</strong></h4>
</section>
<section id="httpspmc.ncbi.nlm.nih.govarticlespmc4484837" class="level4">
<h4 class="anchored" data-anchor-id="httpspmc.ncbi.nlm.nih.govarticlespmc4484837">- <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC4484837/" class="uri">https://pmc.ncbi.nlm.nih.gov/articles/PMC4484837/</a></h4>
<ul>
<li><a href="https://academic.oup.com/bib/article/19/5/776/3056951" class="uri">https://academic.oup.com/bib/article/19/5/776/3056951</a></li>
</ul>
<p>Comparison of normalization methods</p>
<ul>
<li><a href="https://bmcgenomics.biomedcentral.com/articles/10.1186/s12864-015-2353-z" class="uri">https://bmcgenomics.biomedcentral.com/articles/10.1186/s12864-015-2353-z</a></li>
</ul>
</section>
<section id="counts-per-million" class="level2">
<h2 class="anchored" data-anchor-id="counts-per-million">Counts per million</h2>
</section>
<section id="tmm" class="level2">
<h2 class="anchored" data-anchor-id="tmm">TMM</h2>
<p><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC2864565/pdf/gb-2010-11-3-r25.pdf" class="uri">https://pmc.ncbi.nlm.nih.gov/articles/PMC2864565/pdf/gb-2010-11-3-r25.pdf</a></p>
</section>
</section>
<section id="filtering-lowly-expressed-genes" class="level1">
<h1>Filtering lowly-expressed genes</h1>
<section id="cpm-cuttoff" class="level2">
<h2 class="anchored" data-anchor-id="cpm-cuttoff">CPM cuttoff</h2>
</section>
<section id="filterbyexpr" class="level2">
<h2 class="anchored" data-anchor-id="filterbyexpr">filterByExpr</h2>
</section>
</section>
<section id="filtering-low-quality-samples" class="level1">
<h1>Filtering low-quality samples</h1>
<section id="qc-metrics-based-on-rawlog-normalized-counts" class="level2">
<h2 class="anchored" data-anchor-id="qc-metrics-based-on-rawlog-normalized-counts">QC metrics based on raw/log-normalized counts</h2>
</section>
<section id="qc-metrics-based-on-allexpressed-genes" class="level2">
<h2 class="anchored" data-anchor-id="qc-metrics-based-on-allexpressed-genes">QC metrics based on all/expressed genes</h2>
<p>Samples are required in the filtering process and in TMM (sample vs sample comparison; in CPM library sizes are computed independently)</p>
<p>For sample outlier detection we run PCA with normalized and filtered counts.</p>
<p>It depends on if we have prior knowledge of the samples quality and if those QC metrics that are outliers imply that the RNA composition is atypical or problematic: we can plot that and compare. If there are few samples they are not likely to affect downstream results.</p>
</section>
</section>
<section id="the-order-matters" class="level1">
<h1>The order matters</h1>
<p>What comes first normalization or filtering of genes and samples? Is TMM afected by filtering genes and samples?</p>
<p>Cases:</p>
<ol type="1">
<li>Filtering genes –&gt; filtering samples –&gt; normalization (with librari size only OR TMM)</li>
<li>Filtering genes –&gt; normalization –&gt; filtering samples</li>
<li>Filtering samples –&gt; filtering genes –&gt; normalization</li>
<li>Filtering samples –&gt; normalization –&gt; filtering genes</li>
<li>Normalization –&gt; filtering samples –&gt; filtering genes</li>
<li>Normalization –&gt; filtering genes –&gt; filtering samples</li>
</ol>
<section id="section" class="level4">
<h4 class="anchored" data-anchor-id="section"></h4>
<p>Order or norm and filtering:</p>
<ul>
<li><p><a href="https://support.bioconductor.org/p/116351/#:~:text=If%20you%20must%20filter%20on,same%20procedure%20as%20described%20above." class="uri">https://support.bioconductor.org/p/116351/#:~:text=If%20you%20must%20filter%20on,same%20procedure%20as%20described%20above.</a></p></li>
<li><p><a href="https://support.bioconductor.org/p/123624/" class="uri">https://support.bioconductor.org/p/123624/</a></p></li>
</ul>
<p><strong>TMM normalization with low counts (why an initial round of filtering is required before TMM):</strong></p>
<ul>
<li><a href="https://ltla.github.io/ChIPSeqThoughts/lowcount_norm/lowcount_norm.html" class="uri">https://ltla.github.io/ChIPSeqThoughts/lowcount_norm/lowcount_norm.html</a></li>
</ul>


</section>
</section>

 ]]></description>
  <category>Normalization</category>
  <category>Filtering</category>
  <category>Trimmed Mean of M values</category>
  <category>Lowly-expressed genes</category>
  <category>Low-quality samples</category>
  <category>RNA-seq</category>
  <guid>https://daianna21.github.io/daianna_blog/posts/2024-01-20_Filtering_and_Normalization/</guid>
  <pubDate>Thu, 12 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://daianna21.github.io/daianna_blog/posts/2024-01-20_Filtering_and_Normalization/images/TODO" medium="image"/>
</item>
<item>
  <title>Trimmed Mean of M-values</title>
  <dc:creator>Daianna Gonzalez-Padilla</dc:creator>
  <link>https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/</link>
  <description><![CDATA[ 




<p>⚠️ This page is under development.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Normalization is a critical processing step in RNA-seq data analysis. By normalizing raw read counts generated through transcriptomics assays, we reduce the systematic effects that technical within- and between-samples differences have on the data, making the expression measurements more comparable across genes and samples, and enabling the study of transcriptome dynamics.</p>
<p>Varying sequencing depth among the samples is usually accounted for in normalization methods, where gene counts are scaled by sample <strong>library size</strong> (i.e.&nbsp;total sum of read counts per sample). This consideration is necessary when comparing expression levels across samples but is not the only factor at play, specially when samples are expected to have very variable transcriptomes across experimental conditions.</p>
<p>In a <a href="https://doi.org/10.1186/gb-2010-11-3-r25">pioneer paper of 2010</a>, Mark D. Robinson and Alicia Oshlack introduced the issue of the <span style="background-color: #FFFACD"><strong>RNA composition bias</strong></span> in RNA-seq data, and developed the <strong>Trimmed Mean of M-values (TMM)</strong> method to adjust for it <span class="citation" data-cites="robinson2010">(Robinson and Oshlack 2010)</span>. As a widely-implemented normalization scheme, it is important to understand why sample RNA population differences are a concern for normalization and how TMM accounts for it.</p>
</section>
<section id="what-youll-learn-here" class="level1">
<h1>What you’ll learn here</h1>
<ul>
<li><p>Visualize RNA-seq gene expression estimates as sampling artifacts and the implications of it in downstream differential gene expression (DGE) analysis.</p></li>
<li><p>Understand the <strong>RNA composition bias</strong>: explore cases of transcriptomes differing between samples and how they introduce a proportionality issue in read count data as a result of sampling effects in RNA-seq.</p></li>
<li><p>Demonstrate how such RNA composition cases increase the false positive rates in DGE.</p></li>
<li><p>Learn how the TMM method works to reduce the RNA composition bias.</p></li>
</ul>
</section>
<section id="rna-seq-counts-a-sampling-artifact" class="level1">
<h1>RNA-seq counts: a sampling artifact?</h1>
<section id="hypothetical-scenarios" class="level2">
<h2 class="anchored" data-anchor-id="hypothetical-scenarios">Hypothetical scenarios</h2>
<p>Imagine we have 15 samples across 3 experimental conditions (<span style="color: #EE7AE9"><strong>A</strong></span>, <span style="color: #7CCD7C"><strong>B</strong></span>, and <span style="color: #00B2EE"><strong>C</strong></span>), each containing all the transcripts expressed from 30 genes with the same length. Suppose all transcripts in each sample are sequenced, without restricting the number of sequenced molecules per library. This artificial scenario would result in sequencing reads for all transcripts per gene, thus serving as estimates of true expression<span style="color: #EE4000">*</span>.</p>
<p>Then, think of the following three cases:</p>
<ul>
<li><p><u><strong>Case 1</strong></u><strong>: Highly-expressed genes in one condition only</strong>:</p>
<p>Of the 30 genes, 27 have similar expression levels in all three conditions, and 3 are more highly-expressed in condition <span style="color: #EE7AE9"><strong>A</strong></span> than in the other two conditions (genes <span style="color: #FF4500"><strong>5</strong></span>, <span style="color: #CDCD00"><strong>6</strong></span>, and <span style="color: #AB82FF"><strong>7</strong></span>).</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/images/Case1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="6000"></p>
</figure>
</div>
<p>Below, we generate an initial matrix of raw read counts from a negative binomial distribution centered in 50, for all 30 genes across the 15 samples. Then, we introduce the 3 highly-expressed genes (counts from 1,000 to 2,000) in condition <span style="color: #EE7AE9"><strong>A</strong></span> only.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ComplexHeatmap)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(circlize)</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 samples across 3 conditions </span></span>
<span id="cb1-5">conditions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">################################################################</span></span>
<span id="cb1-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                           Case 1:</span></span>
<span id="cb1-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">################################################################</span></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Raw counts for 30 genes across the 15 samples as:</span></span>
<span id="cb1-12"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## random numbers following a NB with mean = mu and var = mu + (mu^2/size)</span></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12242024</span>)</span>
<span id="cb1-14">expr_case1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">450</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(expr_case1) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditions</span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr_case1) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Introduce the 3 highly-expressed genes in condition A </span></span>
<span id="cb1-19">expr_case1[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene 5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene 6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene 7"</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb1-20"></span>
<span id="cb1-21"></span>
<span id="cb1-22"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Heat map</span></span>
<span id="cb1-23">col_anno <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HeatmapAnnotation</span>(</span>
<span id="cb1-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Condition =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anno_block</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchid1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"palegreen1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deepskyblue1"</span>), </span>
<span id="cb1-25">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_name =</span> T), </span>
<span id="cb1-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">annotation_name_gp =</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>))</span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(expr_case1,</span>
<span id="cb1-29">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Raw counts"</span>, </span>
<span id="cb1-30">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_annotation =</span> col_anno, </span>
<span id="cb1-31">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), </span>
<span id="cb1-32">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mistyrose2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rosybrown2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>)),</span>
<span id="cb1-33">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_rows =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb1-34">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb1-35">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_split =</span> conditions,</span>
<span id="cb1-36">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Samples"</span>,</span>
<span id="cb1-37">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb1-38">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb1-39">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb1-40">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_rot =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb1-41">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb1-42">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb1-43">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb1-44">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb1-45">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb1-46">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)</span>
<span id="cb1-47">)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_raw_expr_case1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p><u><strong>Case 2</strong></u><strong>: Genes expressed uniquely in one condition</strong>:</p>
<p>In a separate scenario, imagine that of the 30 genes, half are similarly expressed across the three conditions and half are uniquely expressed in condition <span style="color: #EE7AE9"><strong>A</strong></span>, but in the same expression levels as the other genes. In such case, samples of condition <span style="color: #EE7AE9"><strong>A</strong></span> have twice the number of expressed genes that samples have in <span style="color: #7CCD7C"><strong>B</strong></span> and <span style="color: #00B2EE"><strong>C</strong></span>.</p>
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/images/Case2.png" class="img-fluid" width="4800"></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">################################################################</span></span>
<span id="cb2-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                           Case 2:</span></span>
<span id="cb2-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">################################################################</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 15 genes similarly expressed in all samples</span></span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12242024</span>)</span>
<span id="cb2-7">expr_case2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">225</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(expr_case2) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditions</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Add 15 genes expressed in condition A samples only</span></span>
<span id="cb2-11">expr_case2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(expr_case2, </span>
<span id="cb2-12">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb2-13">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>))</span>
<span id="cb2-14">              )</span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr_case2) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Heat map</span></span>
<span id="cb2-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(expr_case2,</span>
<span id="cb2-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Raw counts"</span>, </span>
<span id="cb2-21">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_annotation =</span> col_anno, </span>
<span id="cb2-22">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), </span>
<span id="cb2-23">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray95"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mistyrose2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rosybrown2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>)),</span>
<span id="cb2-24">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_rows =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb2-25">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb2-26">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_split =</span> conditions,</span>
<span id="cb2-27">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Samples"</span>,</span>
<span id="cb2-28">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb2-29">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb2-30">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb2-31">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_rot =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-32">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb2-33">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb2-34">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb2-35">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb2-36">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb2-37">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)</span>
<span id="cb2-38">)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_raw_expr_case2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div></li>
<li><p><u><strong>Case 3</strong></u><strong>: Highly-expressed genes uniquely in one condition</strong>:</p>
<p>In the third scenario, of the 30 genes, 27 have similar expression levels in all 3 conditions, and 3 are uniquely expressed in condition <span style="color: #EE7AE9"><strong>A</strong></span> and are more high-expressed than the rest of genes (genes <span style="color: #EEAEEE"><strong>28</strong></span>, <span style="color: #8EE5EE"><strong>29</strong></span>, and <span style="color: #A2B5CD"><strong>30</strong></span>).</p>
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/images/Case3.png" class="img-fluid"></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">################################################################</span></span>
<span id="cb3-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##                           Case 3:</span></span>
<span id="cb3-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">################################################################</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 27 similarly expressed genes in all samples</span></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12242024</span>)</span>
<span id="cb3-7">expr_case3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">405</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>)</span>
<span id="cb3-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(expr_case3) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditions</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Add the 3 highly-expressed genes in condition A only</span></span>
<span id="cb3-11">expr_case3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(expr_case3, </span>
<span id="cb3-12">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), </span>
<span id="cb3-13">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>))</span>
<span id="cb3-14">              )</span>
<span id="cb3-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr_case3) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Heat map</span></span>
<span id="cb3-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(expr_case3,</span>
<span id="cb3-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Raw counts"</span>, </span>
<span id="cb3-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_annotation =</span> col_anno, </span>
<span id="cb3-21">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), </span>
<span id="cb3-22">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray95"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mistyrose2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rosybrown2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>)),</span>
<span id="cb3-23">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_rows =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb3-24">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb3-25">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_split =</span> conditions,</span>
<span id="cb3-26">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Samples"</span>,</span>
<span id="cb3-27">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb3-28">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb3-29">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb3-30">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_rot =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-31">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb3-32">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb3-33">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb3-34">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb3-35">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb3-36">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)</span>
<span id="cb3-37">)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_raw_expr_case3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div></li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p><span style="color: #EE4000">*</span>The number of reads mapping to a given gene depends on gene expression (number of gene transcripts), but also gene length: larger genes result in more mapping reads. Thus, read counts are not direct estimations of gene expression. In our examples, however, we assumed all genes have the same length so that read counts reflect expression.</p>
</div>
</div>
</section>
<section id="transcriptomes-that-are-naturally-different" class="level2">
<h2 class="anchored" data-anchor-id="transcriptomes-that-are-naturally-different">Transcriptomes that are naturally different</h2>
<p>Something maybe evident but worth showing is that the sizes of the “true” total libraries we just generated, vary considerably between samples in these three hypothetical but not unlikely scenarios. In all cases, samples in condition <span style="color: #EE7AE9"><strong>A</strong></span> have greater libraries because of highly-expressed genes in <u><strong>Case 1</strong></u>, more expressed genes in <u><strong>Case 2</strong></u>, or both in <u><strong>Case 3</strong></u>, as presented in the below bar plots.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Sample library sizes and conditions</span></span>
<span id="cb4-4">library_sizes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case1"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(expr_case1, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sum),</span>
<span id="cb4-5">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(expr_case2, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sum),</span>
<span id="cb4-6">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case3"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(expr_case3, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sum),</span>
<span id="cb4-7">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>),</span>
<span id="cb4-8">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Condition"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> conditions)</span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Order samples for plotting</span></span>
<span id="cb4-11">library_sizes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(library_sizes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sample, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(library_sizes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sample))</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bar plot for library sizes in each case </span></span>
<span id="cb4-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb4-15">  </span>
<span id="cb4-16">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## args for adding numbers</span></span>
<span id="cb4-17">  ynum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(case <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb4-18"></span>
<span id="cb4-19">  plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> library_sizes, </span>
<span id="cb4-20">                 <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> sample, </span>
<span id="cb4-21">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .data[[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case"</span>, case)]], </span>
<span id="cb4-22">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> Condition)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> .data[[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case"</span>, case)]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ynum, </span>
<span id="cb4-25">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> .data[[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case"</span>, case)]]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case"</span>, case, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"library sizes"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total read counts"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchid1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"palegreen1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deepskyblue1"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), </span>
<span id="cb4-30">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb4-31">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb4-32">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb4-33">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb4-34">  </span>
<span id="cb4-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(plot)</span>
<span id="cb4-36">}</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_lib_sizes-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_lib_sizes-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_lib_sizes-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="randomly-picking-reads" class="level2">
<h2 class="anchored" data-anchor-id="randomly-picking-reads">Randomly picking reads 🤏🏼</h2>
<p>The differences in total expression between samples wouldn’t represent a major issue if we had the capacity to sequence all molecules present in each sample, just as we have been assuming. But in reality, in RNA-sequencing experiments we have a fixed number of reads per library, meaning not all molecules can be sequenced in each sample but there’s a sampling of molecules from which reads are generated. Think of it as having the pool of reads for all transcripts expressed in a sample, and having to randomly select a fixed number of them.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/images/sampling.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>For this reason, RNA-seq counts suffer from <strong>sampling effects</strong>. In the next section we’ll clearly see why this property in RNA-seq data represents an issue in downstrem analysis.</p>
</section>
</section>
<section id="the-rna-composition-bias" class="level1">
<h1>The RNA composition bias</h1>
<p>The sampling of molecules introduces a proportionality problem in the RNA-seq count data: in those samples with greater total expression, caused by a number of highly-expressed genes (<u><strong>Case 1</strong></u>), a greater number of expressed genes (<u><strong>Case 2</strong></u>), or both (<u><strong>Case 3</strong></u>), a greater proportion of reads will come from such genes, taking away reads for all the other genes and apparently reducing their expression. This is depicted in the previous figure: look how in condition <span style="color: #EE7AE9"><strong>A</strong></span>, in the first case more reads from the highly-expressed genes <span style="color: #FF4500"><strong>5</strong></span>, <span style="color: #CDCD00"><strong>6</strong></span>, and <span style="color: #AB82FF"><strong>7</strong></span> are selected; in the second case, reads from the genes <span style="color: #F5CCE4"><strong>16</strong></span>, <span style="color: #F6CBB7"><strong>17</strong></span>, …, <span style="color: #8EE5EE"><strong>29</strong></span>, <span style="color: #A2B5CD"><strong>30</strong></span>, expressed in condition A only, reduce the number of reads for the other genes, and in the third case most selected reads correspond to the condition A-only highly-expressed genes <span style="color: #EEAEEE"><strong>28</strong></span>, <span style="color: #8EE5EE"><strong>29</strong></span>, and <span style="color: #A2B5CD"><strong>30</strong></span>.</p>
<p>This is known as the <span style="background-color: #FFFACD"><strong>RNA composition or population bias</strong></span>: the molecule sampling in sequencing experiments artificially reduce the expression of under-sampled genes in samples with larger RNA content, and also leads to increased gene expression in samples with lowly-expressed genes, thus implying RNA-seq count data sets need to be further processed to make accurate inferences from them.</p>
<p>In the next code we simulate this read sampling by randomly selecting 650 reads per sample in each case and plotting the proportion that correspond to each gene. Note that by selecting the same number of reads across samples, library size is held constant and no differences in read counts are due to sequencing depth.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rlang)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(reshape2)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(Polychrome)</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb5-6">  </span>
<span id="cb5-7">  expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_expr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expr_case"</span>, case)))</span>
<span id="cb5-8">  </span>
<span id="cb5-9">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Create pool of reads per gene in each sample</span></span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(expr) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> library_sizes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sample</span>
<span id="cb5-11">  reads_per_gene_per_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(expr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(sample) {<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr), sample)})</span>
<span id="cb5-12">  </span>
<span id="cb5-13">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Randomly select 650 reads per sample</span></span>
<span id="cb5-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12242024</span>)</span>
<span id="cb5-15">  reads_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(reads_per_gene_per_sample, </span>
<span id="cb5-16">                         <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(sample_reads) {<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sample_reads, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">650</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)})</span>
<span id="cb5-17">  </span>
<span id="cb5-18">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Read counts per gene after sampling</span></span>
<span id="cb5-19">  rna_seq_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(reads_sample, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(sample){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(sample)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr)]})</span>
<span id="cb5-20">  rna_seq_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(cbind, rna_seq_expr))</span>
<span id="cb5-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(rna_seq_expr) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr)</span>
<span id="cb5-22">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Gene with NA = 0 reads</span></span>
<span id="cb5-23">  rna_seq_expr[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(rna_seq_expr)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-24">  </span>
<span id="cb5-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assign</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_seq_expr_case"</span>, case), rna_seq_expr)</span>
<span id="cb5-26">  rna_seq_expr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(rna_seq_expr)</span>
<span id="cb5-27">  </span>
<span id="cb5-28">  rna_seq_expr_melted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(rna_seq_expr)</span>
<span id="cb5-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_seq_expr_melted) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sample"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>)</span>
<span id="cb5-30"></span>
<span id="cb5-31">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Order genes for plotting</span></span>
<span id="cb5-32">  rna_seq_expr_melted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(rna_seq_expr_melted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span>
<span id="cb5-33">  </span>
<span id="cb5-34">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Color palette for genes</span></span>
<span id="cb5-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12212024</span>)</span>
<span id="cb5-36">  col_palette <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hcl.colors</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pastel 1"</span>), </span>
<span id="cb5-37">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hcl.colors</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PinkYl"</span>),</span>
<span id="cb5-38">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hcl.colors</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cyan-Magenta"</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> F)</span>
<span id="cb5-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(col_palette) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(expr)</span>
<span id="cb5-40">  col_palette[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orangered"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yellow3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mediumpurple1"</span>, </span>
<span id="cb5-41">                                                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plum2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cadetblue1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightsteelblue"</span>)</span>
<span id="cb5-42">  </span>
<span id="cb5-43">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(case <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb5-44">    alphas <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span>))</span>
<span id="cb5-45">  }</span>
<span id="cb5-46">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(case <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>){</span>
<span id="cb5-47">    alphas <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb5-48">  }</span>
<span id="cb5-49">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>{</span>
<span id="cb5-50">    alphas <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb5-51">  }</span>
<span id="cb5-52">  </span>
<span id="cb5-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assign</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alphas_case_"</span>, case), alphas)</span>
<span id="cb5-54">   </span>
<span id="cb5-55">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bar plot</span></span>
<span id="cb5-56">  plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> rna_seq_expr_melted, </span>
<span id="cb5-57">                       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> sample, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> count, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> gene)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-58">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-59">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-60">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case"</span>, case), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, </span>
<span id="cb5-61">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Reads per gene after sampling"</span>, </span>
<span id="cb5-62">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gene"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-63">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> col_palette) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-64">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gene"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> alphas) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-65">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), </span>
<span id="cb5-66">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb5-67">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb5-68">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb5-69">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), </span>
<span id="cb5-70">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb5-71">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>))</span>
<span id="cb5-72">  </span>
<span id="cb5-73">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(plot)</span>
<span id="cb5-74">}</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_gene_props-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_gene_props-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_gene_props-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In the following heat maps we plot the count matrices after sampling.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot heat map of RNA-seq counts in each case</span></span>
<span id="cb6-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb6-3">  </span>
<span id="cb6-4">  rna_seq_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_expr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_seq_expr_case"</span>, case)))</span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_seq_expr) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditions</span>
<span id="cb6-6">  </span>
<span id="cb6-7">  h <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(rna_seq_expr,</span>
<span id="cb6-8">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA-seq counts"</span>, </span>
<span id="cb6-9">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">top_annotation =</span> col_anno, </span>
<span id="cb6-10">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_rows =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb6-11">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb6-12">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), </span>
<span id="cb6-13">                           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray95"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mistyrose2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rosybrown2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>)),</span>
<span id="cb6-14">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_split =</span> conditions,</span>
<span id="cb6-15">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb6-16">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb6-17">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Samples"</span>,</span>
<span id="cb6-18">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb6-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb6-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb6-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb6-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb6-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_rot =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb6-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb6-25">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)</span>
<span id="cb6-26">  )</span>
<span id="cb6-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(h)</span>
<span id="cb6-28">  </span>
<span id="cb6-29">}</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_RNAseq_expr-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_RNAseq_expr-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/plot_RNAseq_expr-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Confirming the aforementioned, note in the bar plots the dominance in read proportion of highly-expressed and/or unique genes in condition <span style="color: #EE7AE9"><strong>A</strong></span>, and in the heat maps, the consequent reduction in expression of non-highly expressed and shared genes, in the same condition.</p>
</section>
<section id="more-false-positives" class="level1">
<h1>More false positives …</h1>
<p>By design, we know that most genes are not differentially expressed (DE). Let’s formally test if the differences in the mean expression of each gene in <span style="background-color: #8DB6CD"><strong>A vs B</strong></span>, <span style="background-color: #FF82AB"><strong>A vs C</strong></span>, and <span style="background-color: #A2CD5A"><strong>B vs C</strong></span> with the original data, are statistically significant with two sample t-tests (but keep in mind this tests assumes data normality and equal variances in both groups).</p>
<p>Below we are plotting the <em>t</em>-statistics per gene for each comparison, which capture the sign and size of the difference in gene expression between conditions. The expression changes that were significant (<em>p</em>-value &lt;0.05) have a “*” above the bar.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## t-test for total or sampled counts</span></span>
<span id="cb7-4">t_test_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(expr_counts){</span>
<span id="cb7-5">  </span>
<span id="cb7-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb7-7">  </span>
<span id="cb7-8">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Total raw counts</span></span>
<span id="cb7-9">    expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_expr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(expr_counts, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_case"</span>, case))) </span>
<span id="cb7-10">    expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(expr)</span>
<span id="cb7-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(expr) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditions</span>
<span id="cb7-12">     </span>
<span id="cb7-13">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Create matrices to save gene p-values and t-stats</span></span>
<span id="cb7-14">    pvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-15">    tstats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(pvals) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(tstats)  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A_vs_B"</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A_vs_C"</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B_vs_C"</span>)</span>
<span id="cb7-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(pvals) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(tstats) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb7-18">    </span>
<span id="cb7-19">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Iterate over genes</span></span>
<span id="cb7-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(expr)){</span>
<span id="cb7-21">        </span>
<span id="cb7-22">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## t-test for gene expr in condition1 vs condition2</span></span>
<span id="cb7-23">      condition_pairs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>),  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>),  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>))</span>
<span id="cb7-24">      </span>
<span id="cb7-25">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>((case <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (case <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>)){</span>
<span id="cb7-26">        condition_pairs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>),  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>))</span>
<span id="cb7-27">      }</span>
<span id="cb7-28">      </span>
<span id="cb7-29">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(condition_pair <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> condition_pairs){</span>
<span id="cb7-30">        </span>
<span id="cb7-31">        comparison <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(condition_pair[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_vs_"</span>, condition_pair[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb7-32">        gene <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, i)</span>
<span id="cb7-33">        </span>
<span id="cb7-34">        gene_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> expr[i, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(expr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> condition_pair]</span>
<span id="cb7-35">        formula <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gene_expr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Condition</span>
<span id="cb7-36">        results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> formula, </span>
<span id="cb7-37">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Condition"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> conditions[conditions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> condition_pair]))</span>
<span id="cb7-38">          </span>
<span id="cb7-39">          pvals[gene, comparison] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.value</span>
<span id="cb7-40">          tstats[gene, comparison] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> results<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>statistic</span>
<span id="cb7-41">      </span>
<span id="cb7-42">      }</span>
<span id="cb7-43">      </span>
<span id="cb7-44">    }</span>
<span id="cb7-45">    </span>
<span id="cb7-46">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plot t-stats (expression change size)</span></span>
<span id="cb7-47">    melted_pvals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(pvals))</span>
<span id="cb7-48">    melted_tstats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">melt</span>(tstats))</span>
<span id="cb7-49">    </span>
<span id="cb7-50">    data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(melted_pvals, melted_tstats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>value)</span>
<span id="cb7-51">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(data) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"comparison"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>)</span>
<span id="cb7-52">    data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>signif <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(p){ <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>){<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span>} <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>{<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>}})</span>
<span id="cb7-53">    </span>
<span id="cb7-54">    text_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(expr_counts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expr"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-55">    </span>
<span id="cb7-56">    plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> t, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> comparison, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> comparison)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-57">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodge"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, </span>
<span id="cb7-58">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.65</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-59">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sign</span>(t))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>text_pos), </span>
<span id="cb7-60">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> signif, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> comparison, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> comparison), </span>
<span id="cb7-61">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_dodge</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb7-62">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-63">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-64">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case"</span>, case), </span>
<span id="cb7-65">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True change in expression"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-66">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A_vs_B"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8DB6CD"</span>, </span>
<span id="cb7-67">                                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A_vs_C"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF82AB"</span>, </span>
<span id="cb7-68">                                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B_vs_C"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A2CD5A"</span>), </span>
<span id="cb7-69">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A vs B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A vs C"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B vs C"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-70">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A_vs_B"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8DB6CD"</span>,</span>
<span id="cb7-71">                                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A_vs_C"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF82AB"</span>,</span>
<span id="cb7-72">                                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B_vs_C"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A2CD5A"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-73">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb7-74">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb7-75">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), </span>
<span id="cb7-76">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), </span>
<span id="cb7-77">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), </span>
<span id="cb7-78">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), </span>
<span id="cb7-79">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb7-80">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>))</span>
<span id="cb7-81">    </span>
<span id="cb7-82">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(plot)</span>
<span id="cb7-83">  }</span>
<span id="cb7-84"></span>
<span id="cb7-85">}</span>
<span id="cb7-86"></span>
<span id="cb7-87"></span>
<span id="cb7-88"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t_test_expr</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expr_counts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"expr"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/t_test_raw_counts-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="624"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/t_test_raw_counts-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="624"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/t_test_raw_counts-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="624"></p>
</figure>
</div>
</div>
</div>
<p>Not surprisingly, highly-expressed and unique genes in condition <span style="color: #FF83FA"><strong>A</strong></span> have significantly higher expression when compared to the other two conditions, and the rest of the genes don’t show significant expression changes except for a few false positives.</p>
<p>Now, as you may suspect, the decrease in counts for genes in condition <span style="color: #FF83FA"><strong>A</strong></span> after sampling result in false discoveries of differential expression.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t_test_expr</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expr_counts =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_seq_expr"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/t_tests_RNAseq_data-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/t_tests_RNAseq_data-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/t_tests_RNAseq_data-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>TODO: This proportionality issue can also decrease the power to detect true differentially expressed genes. For instance, in <u><strong>Case 1</strong></u> look how after read sampling, the expression of highly-expressed genes reduces in condition A and becomes more similar to that of the other conditions (heat map), and consequently, the decreased sizes in their expression changes (bar plot).</p>
</div>
</div>
</section>
<section id="how-to-solve-the-problem" class="level1">
<h1>How to solve the problem?</h1>
<p>Let’s denote the true and unknown total library size of each sample <img src="https://latex.codecogs.com/png.latex?i"> by <img src="https://latex.codecogs.com/png.latex?S_i"> (i.e.&nbsp;the complete pool of reads per sample), and the RNA-seq library size by <img src="https://latex.codecogs.com/png.latex?N_i"> (reads selected after sampling). We define the total (and unknown) read counts of gene <img src="https://latex.codecogs.com/png.latex?g"> in samples <img src="https://latex.codecogs.com/png.latex?k"> and <img src="https://latex.codecogs.com/png.latex?r"> as <img src="https://latex.codecogs.com/png.latex?z_%7Bgk%7D"> and <img src="https://latex.codecogs.com/png.latex?z_%7Bgr%7D">, respectively.</p>
<p>Then, the number of reads after sampling for <img src="https://latex.codecogs.com/png.latex?g"> in samples <img src="https://latex.codecogs.com/png.latex?k"> and <img src="https://latex.codecogs.com/png.latex?r"> are given by <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D%20=%20%5Cfrac%7Bz_%7Bgk%7D%7D%7BS_k%7DN_k"> and <img src="https://latex.codecogs.com/png.latex?y_%7Bgr%7D%20=%20%5Cfrac%7Bz_%7Bgr%7D%7D%7BS_r%7DN_r">, respectively. These correspond to the RNA-seq counts to which we have access. We know that <img src="https://latex.codecogs.com/png.latex?S_k"> is <img src="https://latex.codecogs.com/png.latex?%5Calpha"> times greater than <img src="https://latex.codecogs.com/png.latex?S_r">, i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?S_k%20=%20%5Calpha%20S_r">.</p>
<p>If gene <img src="https://latex.codecogs.com/png.latex?g"> is a <strong>true non-DEG</strong> between these two samples, then <img src="https://latex.codecogs.com/png.latex?z_%7Bgk%7D%20=%20z_%7Bgr%7D"> and we expect the counts for these gene to be equal in our RNA-seq count data, i.e., <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D%20=%20y_%7Bgr%7D">. But we know that’s not satisfied since <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D%20=%20%5Cfrac%7Bz_%7Bgk%7D%7D%7BS_k%7DN_k%20=%20%5Cfrac%7Bz_%7Bgr%7D%7D%7B%5Calpha%20S_r%7DN_k"> and given that we fixed the number of selected reads, <img src="https://latex.codecogs.com/png.latex?N_k%20=%20N_r"> and <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D%20=%20%5Cfrac%7Bz_%7Bgr%7D%7D%7B%5Calpha%20S_r%7DN_r%20%E2%89%A0%20%5Cfrac%7Bz_%7Bgr%7D%7D%7BS_r%7DN_r%20=%20y_%7Bgr%7D">. We have that <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D%20%5Calpha%20=%20y_%7Bgr%7D"> and we aim to estimate such factor <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%20%5Cfrac%7BS_k%7D%7BS_r%7D"> to scale read counts in sample <img src="https://latex.codecogs.com/png.latex?k"> to equal them to those in <img src="https://latex.codecogs.com/png.latex?r">. With library size-normalized counts, we’d have <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7By_%7Bgk%7D%7D%7BN_k%7D%20%5Calpha=%20%5Cfrac%7By_%7Bgr%7D%7D%7BN_r%7D">, which is the same as <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7By_%7Bgk%7D%7D%7BN_k%7D%20%5Csqrt%7B%5Calpha%5E2%7D%20=%20%5Cfrac%7By_%7Bgr%7D%7D%7BN_r%7D"> and results in <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7By_%7Bgk%7D%7D%7BN_k%7D%20%5Csqrt%7B%5Calpha%7D%20=%20%5Cfrac%7By_%7Bgr%7D%7D%7BN_r%20%5Csqrt%7B%5Calpha%7D%7D">, which in turn is equivalent to divide library <img src="https://latex.codecogs.com/png.latex?N_k"> by <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7B%5Calpha%7D"> and multiply library <img src="https://latex.codecogs.com/png.latex?N_r"> by <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7B%5Calpha%7D">; that’s what we refer to with the scaling of library sizes.</p>
<p>Now, the fold change in the expression of a non-DEG <img src="https://latex.codecogs.com/png.latex?g"> in sample <img src="https://latex.codecogs.com/png.latex?k"> vs sample <img src="https://latex.codecogs.com/png.latex?r">, <u>after sampling</u>, is given by <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7By_%7Bgk%7D%7D%7By_%7Bgr%7D%7D%20=%20%5Calpha%20%5E%7B-1%7D%20=%20%5Cfrac%7BS_r%7D%7BS_k%7D">. So we are basically aiming to scale library sizes by the inverse of the expression fold change of a non-DEG. This applies to all true non-DEGs.</p>
<p>We cannot estimate <img src="https://latex.codecogs.com/png.latex?S_k"> and <img src="https://latex.codecogs.com/png.latex?S_r"> but we can take advantage of the inverse relationship between <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BS_k%7D%7BS_r%7D"> and the fold changes of non-DEGs, to approximate it by computing a <strong>global mean expression fold change</strong> across <strong>all (assumed) non-DEGs</strong> for sample <img src="https://latex.codecogs.com/png.latex?k"> vs <img src="https://latex.codecogs.com/png.latex?r">.</p>
<p>A visual way to show why we need to estimate <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is, instead of selecting a fixed number of reads in the sampling, we can think of selecting a fixed proportion of reads per sample <img src="https://latex.codecogs.com/png.latex?i"> (<img src="https://latex.codecogs.com/png.latex?p_i%20=%20%5Cfrac%7BN_i%7D%7BS_i%7D">), which would preserve the original true RNA composition of the samples and allow the direct comparison of gene counts between them.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/images/sampling2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>By selecting the same proportion <img src="https://latex.codecogs.com/png.latex?p"> of reads from <img src="https://latex.codecogs.com/png.latex?S_k"> and <img src="https://latex.codecogs.com/png.latex?S_r">, on average we keep <img src="https://latex.codecogs.com/png.latex?z_%7Bgk%7D%20%5Ctimes%20p"> and <img src="https://latex.codecogs.com/png.latex?z_%7Bgr%7D%20%5Ctimes%20p"> reads for gene <img src="https://latex.codecogs.com/png.latex?g"> in samples <img src="https://latex.codecogs.com/png.latex?k"> and <img src="https://latex.codecogs.com/png.latex?r">, making the expression estimates comparable between them. But the reality is that we have a fixed number of reads and <img src="https://latex.codecogs.com/png.latex?p_k%20%E2%89%A0%20p_r">. Multiplying by <img src="https://latex.codecogs.com/png.latex?%5Calpha"> we obtain <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BN_k%7D%7BS_k%7D%20%5Calpha%20=%20%5Cfrac%7BN_r%7D%7BS_r%7D">, making proportions in both samples equal.</p>
</section>
<section id="tmm-method-for-estimating-scaling-factors" class="level1">
<h1>TMM method for estimating scaling factors</h1>
<p>What Mark D. Robinson and Alicia Oshlack proposed with their <span style="background-color: #FFD700"><strong>Trim Mean of M-values</strong></span> method is an empirical approach to approximate <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BS_r%7D%7BS_k%7D">, which can be summarized as follows:</p>
<ol type="1">
<li><p>Compute gene-wise log-normalized expression ratios between samples <img src="https://latex.codecogs.com/png.latex?k"> and <img src="https://latex.codecogs.com/png.latex?r">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AM_%7Bgk%7D%5Er%20=%20log_2(%5Cfrac%7By_%7Bgk%7D%7D%7BN_k%7D%20/%5Cfrac%7By_%7Bgr%7D%7D%7BN_r%7D%20)%0A"></p>
<p>and the mean gene log-normalized expression across both samples as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AA_g%20=%20%5Cfrac%7Blog_2(%5Cfrac%7By_%7Bgk%7D%7D%7BN_k%7D)%20+%20log_2(%5Cfrac%7By_%7Bgr%7D%7D%7BN_r%7D)%7D%7B2%7D%0A"> where <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D"> and <img src="https://latex.codecogs.com/png.latex?y_%7Bgr%7D"> are the RNA-seq counts of gene <img src="https://latex.codecogs.com/png.latex?g"> in samples <img src="https://latex.codecogs.com/png.latex?k"> and <img src="https://latex.codecogs.com/png.latex?r"> (after sampling).</p>
<p>In the next code we compute the <img src="https://latex.codecogs.com/png.latex?M"> and <img src="https://latex.codecogs.com/png.latex?A"> values for all genes in each case, comparing sample 1 of condition <span style="color: #EE7AE9"><strong>A</strong></span> vs sample 5 of condition <span style="color: #7CCD7C"><strong>B</strong></span>. We then plot <img src="https://latex.codecogs.com/png.latex?M"> vs <img src="https://latex.codecogs.com/png.latex?A"> values to spot up and down differentially expressed genes.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">MA_plots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb9-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb9-3"></span>
<span id="cb9-4">   <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Select sample 1 as k and 5 as r</span></span>
<span id="cb9-5">    rna_seq_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_expr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_seq_expr_case"</span>, case))))</span>
<span id="cb9-6">    yg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_seq_expr[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span>
<span id="cb9-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(yg) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>)</span>
<span id="cb9-8"></span>
<span id="cb9-9">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Replace 0s with 1 (smallest positive integer)</span></span>
<span id="cb9-10">    yg[yg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb9-11"></span>
<span id="cb9-12">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Library sizes</span></span>
<span id="cb9-13">    Nk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(yg)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>]</span>
<span id="cb9-14">    Nr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(yg)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>]</span>
<span id="cb9-15"></span>
<span id="cb9-16">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Compute M and A values</span></span>
<span id="cb9-17">    M_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>( (yg[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Nk) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> </span>
<span id="cb9-18">                      (yg[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Nr) )</span>
<span id="cb9-19">    A_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(yg[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Nk) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log2</span>(yg[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Nr)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb9-20"></span>
<span id="cb9-21">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Variance weights x gene (see step 3)</span></span>
<span id="cb9-22">    vg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ((Nk <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yg[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(Nk <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> yg[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ((Nr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yg[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(Nr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> yg[, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>]))</span>
<span id="cb9-23"></span>
<span id="cb9-24">    df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> M_values, </span>
<span id="cb9-25">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> A_values, </span>
<span id="cb9-26">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> vg,</span>
<span id="cb9-27">                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gene"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(M_values))</span>
<span id="cb9-28">    df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gene)</span>
<span id="cb9-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assign</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"df_case_"</span>, case), df)</span>
<span id="cb9-30"></span>
<span id="cb9-31">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## M vs A plot </span></span>
<span id="cb9-32">    plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> M, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> gene)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-33">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-34">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-35">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> col_palette) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-36">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-37">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gene"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alphas_case_"</span>, case))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-38">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.55</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray40"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-39">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>M), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick3"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-40">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case"</span>, case), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A values"</span>, </span>
<span id="cb9-41">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M values"</span>, </span>
<span id="cb9-42">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gene"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-43">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), </span>
<span id="cb9-44">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), </span>
<span id="cb9-45">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), </span>
<span id="cb9-46">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb9-47">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb9-48">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span>), </span>
<span id="cb9-49">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.5</span>), </span>
<span id="cb9-50">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb9-51">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>))</span>
<span id="cb9-52"></span>
<span id="cb9-53">  MA_plots[[case]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot</span>
<span id="cb9-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(plot)</span>
<span id="cb9-55"></span>
<span id="cb9-56">}</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/MA_plots-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="436"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/MA_plots-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="436"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/MA_plots-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="436"></p>
</figure>
</div>
</div>
</div></li>
</ol>
<p>Just as we have previously demonstrated, observe how all genes have logFCs (<img src="https://latex.codecogs.com/png.latex?M"> values) offset from zero, deviating their mean as well (red dashed line).</p>
<ol start="2" type="1">
<li><p>Trim the upper and lower x% (30% by default) of <img src="https://latex.codecogs.com/png.latex?M"> values that represent genes with biased expression towards one condition, as well as the upper and lower y% (5% by default) of <img src="https://latex.codecogs.com/png.latex?A"> values, corresponding to genes with extreme expression. This keeps genes that are <u>considered non-differentially and moderately expressed</u> and therefore useful to <u>estimate the global expression fold change</u> between samples.</p>
<p>Given the very few genes we have in our simulated data, in total we’ll trim 20% of <img src="https://latex.codecogs.com/png.latex?M"> values (10% up and 10% low) and 10% of <img src="https://latex.codecogs.com/png.latex?A"> values (5% up and 5% low).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cowplot)</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(metric <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>)){</span>
<span id="cb10-4"></span>
<span id="cb10-5">  x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb10-6"></span>
<span id="cb10-7">  plots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb10-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb10-9"></span>
<span id="cb10-10">    df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"df_case_"</span>, case))</span>
<span id="cb10-11"></span>
<span id="cb10-12">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Trim upper and lower % </span></span>
<span id="cb10-13">    df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trim"</span>, metric)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb10-14">    extremes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(df[, metric])[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x)], </span>
<span id="cb10-15">                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">order</span>(df[, metric]))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x)])</span>
<span id="cb10-16">    df[extremes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trim"</span>, metric)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb10-17"></span>
<span id="cb10-18">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Box plot</span></span>
<span id="cb10-19">    pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">08</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12242024</span>)</span>
<span id="cb10-20"></span>
<span id="cb10-21">    plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(metric))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-22">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> gene, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> gene), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.85</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> pos) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-23">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> col_palette) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-24">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_alpha_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alphas_case_"</span>, case))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-25">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trim"</span>, metric))), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>,</span>
<span id="cb10-26">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stroke =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.55</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> pos) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-27">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_shape_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TRUE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FALSE"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-28">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray40"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-29">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-30">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case"</span>, case), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(metric, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" values"</span>), </span>
<span id="cb10-31">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gene"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Trimmed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-32">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-33">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), </span>
<span id="cb10-34">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks.length.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb10-35">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), </span>
<span id="cb10-36">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb10-37">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), </span>
<span id="cb10-38">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), </span>
<span id="cb10-39">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb10-40">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.key.height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>))</span>
<span id="cb10-41"></span>
<span id="cb10-42">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>){</span>
<span id="cb10-43">        plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-44">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.55</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray40"</span>) </span>
<span id="cb10-45"></span>
<span id="cb10-46">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(case <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb10-47">          legend <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_legend</span>(plot)</span>
<span id="cb10-48">        }</span>
<span id="cb10-49">      }</span>
<span id="cb10-50"></span>
<span id="cb10-51">      plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb10-52">      plots[[case]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot</span>
<span id="cb10-53">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assign</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"df_case_"</span>, case), df)</span>
<span id="cb10-54">  }</span>
<span id="cb10-55"></span>
<span id="cb10-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_grid</span>(plots[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], plots[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], plots[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], legend, </span>
<span id="cb10-57">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rel_widths =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>)))</span>
<span id="cb10-58"></span>
<span id="cb10-59">}</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/trimming_boxplots-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/trimming_boxplots-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Subset to non-trimmed genes</span></span>
<span id="cb11-2">df_trimmed_case_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_case_1[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>df_case_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trimM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>df_case_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trimA, ]</span>
<span id="cb11-3">df_trimmed_case_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_case_2[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>df_case_2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trimM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>df_case_2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trimA, ]</span>
<span id="cb11-4">df_trimmed_case_3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_case_3[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>df_case_3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trimM <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>df_case_3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trimA, ]</span></code></pre></div>
</div></li>
<li><p>Estimate the average of the <img src="https://latex.codecogs.com/png.latex?M"> values for not trimmed genes (<img src="https://latex.codecogs.com/png.latex?G%5E*">), each weighted by gene inverse variances (<img src="https://latex.codecogs.com/png.latex?w_%7Bgk%7D%5Er">) to account for lower variances in logFCs of genes with larger read counts.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Af_k%5Er%20=%20%5Cfrac%7B%5Csum_%7Bg%20%5Cin%20G%5E*%7D%20w_%7Bgk%7D%5Er%20M_%7Bgk%7D%5Er%7D%7B%5Csum_%7Bg%20%5Cin%20G%5E*%7Dw_%7Bgk%7D%5Er%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?w_%7Bgk%7D%5Er%20=%201/v_%7Bgk%7D%5Er"> and <img src="https://latex.codecogs.com/png.latex?v_%7Bgk%7D%5Er%20=%20%5Cfrac%7BN_k-Y_%7Bgk%7D%7D%7BN_kY_%7Bgk%7D%7D%20+%20%5Cfrac%7BN_r-Y_%7Bgr%7D%7D%7BN_rY_%7Bgr%7D%7D">.</p>
<p>Then, we define the normalization factor <img src="https://latex.codecogs.com/png.latex?TMM_k%5Er%20%20=%202%5E%7Bf_k%5Er%7D"> as an estimate of <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B%5Calpha%7D=%5Cfrac%7BS_r%7D%7BS_k%7D"> and we scale the library <img src="https://latex.codecogs.com/png.latex?k"> by <img src="https://latex.codecogs.com/png.latex?%5Csqrt%20%7BTMM_k%5Er%7D"> and library <img src="https://latex.codecogs.com/png.latex?r"> by <img src="https://latex.codecogs.com/png.latex?1/%5Csqrt%7BTMM_k%5Er%7D">. <img src="https://latex.codecogs.com/png.latex?TMM"> is the global fold change in expression of sample <img src="https://latex.codecogs.com/png.latex?k"> compared to sample <img src="https://latex.codecogs.com/png.latex?r"> after sampling reads.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(edgeR)</span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Compute scaling factors </span></span>
<span id="cb12-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb12-5"></span>
<span id="cb12-6">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Non-trimmed genes G*</span></span>
<span id="cb12-7">    df_trimmed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"df_trimmed_case_"</span>, case))</span>
<span id="cb12-8"></span>
<span id="cb12-9">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Inverse variance weights </span></span>
<span id="cb12-10">    df_trimmed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>df_trimmed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>v</span>
<span id="cb12-11"></span>
<span id="cb12-12">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Weighted sum of M values</span></span>
<span id="cb12-13">    f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(df_trimmed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> df_trimmed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>w)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(df_trimmed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>w)</span>
<span id="cb12-14">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Norm factor</span></span>
<span id="cb12-15">    tmm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> f</span>
<span id="cb12-16"></span>
<span id="cb12-17">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Scaling factors for k and r libraries</span></span>
<span id="cb12-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Case "</span>, case, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":"</span>))</span>
<span id="cb12-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f = log2(TMM) ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(f, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span>
<span id="cb12-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TMM factor = 2^f (aprox to 1/α) ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(tmm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span>
<span id="cb12-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Manually-computed scaling factors (√TMM for k and 1/√TMM r):"</span>, </span>
<span id="cb12-22">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(tmm), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb12-23">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(tmm), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span>
<span id="cb12-24"></span>
<span id="cb12-25">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Factors returned by edgeR::calcNormFactors() based on RNA-seq counts</span></span>
<span id="cb12-26">    rna_seq_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_seq_expr_case"</span>, case)))</span>
<span id="cb12-27">    yg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_seq_expr[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span>
<span id="cb12-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(yg) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>)</span>
<span id="cb12-29"></span>
<span id="cb12-30">    edgeR_NormFactors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calcNormFactors</span>(yg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TMM"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refColumn =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, </span>
<span id="cb12-31">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logratioTrim =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sumTrim =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb12-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assign</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"edgeR_NormFactors_"</span>, case), edgeR_NormFactors)</span>
<span id="cb12-33"></span>
<span id="cb12-34">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"edgeR scaling factors for k and r:"</span>,</span>
<span id="cb12-35">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(edgeR_NormFactors), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb12-36">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>)))</span>
<span id="cb12-37"></span>
<span id="cb12-38">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## True Sr/Sk</span></span>
<span id="cb12-39">    ratio_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> library_sizes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case"</span>, case)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> </span>
<span id="cb12-40">                  library_sizes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lib_size_case"</span>, case)] </span>
<span id="cb12-41">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True FC = 1/α = Sr/S_k = "</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(ratio_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span>
<span id="cb12-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True scaling factors (√1/α for k and 1/√1/α r):"</span>, </span>
<span id="cb12-43">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(ratio_true), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb12-44">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(ratio_true), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span>
<span id="cb12-45"></span>
<span id="cb12-46">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Save </span></span>
<span id="cb12-47"></span>
<span id="cb12-48">}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "f = log2(TMM) = -1.5895"
[1] "TMM factor = 2^f (aprox to 1/α) = 0.33229"
[1] "Manually-computed scaling factors (√TMM for k and 1/√TMM r): 0.57644 1.7348"
[1] "edgeR scaling factors for k and r: 0.57644 1.7348"
[1] "True FC = 1/α = Sr/S_k =  0.25899"
[1] "True scaling factors (√1/α for k and 1/√1/α r): 0.50891 1.965"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "f = log2(TMM) = -0.45766"
[1] "TMM factor = 2^f (aprox to 1/α) = 0.72817"
[1] "Manually-computed scaling factors (√TMM for k and 1/√TMM r): 0.85333 1.1719"
[1] "edgeR scaling factors for k and r: 0.72308 1.383"
[1] "True FC = 1/α = Sr/S_k =  0.52249"
[1] "True scaling factors (√1/α for k and 1/√1/α r): 0.72284 1.3834"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "f = log2(TMM) = -1.8317"
[1] "TMM factor = 2^f (aprox to 1/α) = 0.28093"
[1] "Manually-computed scaling factors (√TMM for k and 1/√TMM r): 0.53003 1.8867"
[1] "edgeR scaling factors for k and r: 0.49584 2.0168"
[1] "True FC = 1/α = Sr/S_k =  0.19238"
[1] "True scaling factors (√1/α for k and 1/√1/α r): 0.43861 2.2799"</code></pre>
</div>
</div>
<p>Note that in case 2 and 3 the factors we compute manually don’t match with the ones returned by edgeR::calcNormFactors because we transformed 0 counts into 1, whereas the function removes</p></li>
<li><p>These factors are then used to scale the original RNA-seq sample library sizes and normalize counts. Look in the following plots the more homogeneous expression of sample 1 and 5 after normalizing counts by effective (scaled) library sizes.</p></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(case <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb16-2">  </span>
<span id="cb16-3">  rna_seq_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_expr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rna_seq_expr_case"</span>, case)))</span>
<span id="cb16-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(rna_seq_expr) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditions</span>
<span id="cb16-5">  </span>
<span id="cb16-6">  yg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rna_seq_expr[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span>
<span id="cb16-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(yg) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>)</span>
<span id="cb16-8">    </span>
<span id="cb16-9">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Effective lib sizes</span></span>
<span id="cb16-10">  edgeR_NormFactors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"edgeR_NormFactors_"</span>, case))</span>
<span id="cb16-11">  effective_lib_sizes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">650</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> edgeR_NormFactors</span>
<span id="cb16-12">  </span>
<span id="cb16-13">  rna_seq_expr_norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(yg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>effective_lib_sizes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>],</span>
<span id="cb16-14">                             yg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>effective_lib_sizes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>])</span>
<span id="cb16-15">  </span>
<span id="cb16-16">  h <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Heatmap</span>(rna_seq_expr_norm,</span>
<span id="cb16-17">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RNA-seq counts"</span>, </span>
<span id="cb16-18">          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># top_annotation = col_anno, </span></span>
<span id="cb16-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_rows =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb16-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cluster_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb16-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorRamp2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb16-22">                           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray95"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mistyrose2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rosybrown2"</span>)),</span>
<span id="cb16-23">          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># column_split = conditions,</span></span>
<span id="cb16-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb16-25">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show_row_names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb16-26">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Samples"</span>,</span>
<span id="cb16-27">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_title_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb16-28">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>,</span>
<span id="cb16-29">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb16-30">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_gp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontsize =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb16-31">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_names_side =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"left"</span>,</span>
<span id="cb16-32">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">column_names_rot =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb16-33">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_width =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>),</span>
<span id="cb16-34">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">heatmap_height =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">13.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)</span>
<span id="cb16-35">  )</span>
<span id="cb16-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(h)</span>
<span id="cb16-37">  </span>
<span id="cb16-38">}</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/norm_expr_heatmaps-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/norm_expr_heatmaps-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/index_files/figure-html/norm_expr_heatmaps-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
<p>As you may be wondering, what happens with the rest of the samples? have more than two samples. Just as with sample 5, we proceed in the same way using the same reference sample to compute normalization factors for all the others.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>This procedure assumes that <img src="https://latex.codecogs.com/png.latex?y_%7Bgk%7D,%20y_%7Bgr%7D%20%3E0">, so an initial filtering of non-expressed genes is desired. Indeed, <code>edgeR::calcNormFactors()</code> removes zero-expressed genes in advance.</p>
</div>
</div>
<p>DGE analysis</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Which sample to choose as the reference?
</div>
</div>
<div class="callout-body-container callout-body">
<p>If not specified, the TMM method, as implemented in <code>edgeR</code>, selects as the reference the sample whose expression is closer to the average expression across all samples. More specifically, it chooses the sample whose 75th expression quantile, normalized by library size, is closer to the mean of the normalized quantiles for all samples. Check an example <a href="https://www.google.com/search?client=safari&amp;rls=en&amp;q=tmm+reference+sample&amp;ie=UTF-8&amp;oe=UTF-8#fpstate=ive&amp;vld=cid:a7c9a19a,vid:Wdt6jdi-NQo,st:151">here</a>.</p>
</div>
</div>
<p>the … to adjust</p>
<p>Normalization factors</p>
<p>Scaling factors</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Initially, normalizing expression counts by true biological RNA composition differences seems counterintuitive as those are the differences we aim to detect in DGE analysis. But I hope you have it clear now that the problem arises from sampling effects in RNA-seq data, and that gene read counts depend not only on gene expression levels and length, but also on the inherent properties of the RNA samples from which they come.</p>
<p>biological differences in the sample transcriptomes across multiple conditions</p>
<p>Library size normalization is appropiate for replicate samples within the same condition. But when working with multiple experimental conditions, such as tissues and diagnostic groups, that are expected to markedly vary in their transcriptomes, adjusting for RNA composition differences is required to discover genes with true expression changes and discard the similarly-expressed ones.</p>
<p>As we have seen, TMM is a simple but effective method to scale …</p>
<p>In other words, we approximate Sk/Sr as a global expression logFC between samples based on similarly-expressed genes (e.g.&nbsp;housekeeping genes).</p>
<p><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC11107385/" class="uri">https://pmc.ncbi.nlm.nih.gov/articles/PMC11107385/</a></p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-robinson2010" class="csl-entry">
Robinson, Mark D, and Alicia Oshlack. 2010. <span>“A Scaling Normalization Method for Differential Expression Analysis of RNA-Seq Data.”</span> <em>Genome Biology</em> 11 (3). <a href="https://doi.org/10.1186/gb-2010-11-3-r25">https://doi.org/10.1186/gb-2010-11-3-r25</a>.
</div>
</div></section></div> ]]></description>
  <category>Normalization</category>
  <category>RNA composition bias</category>
  <category>Trimmed Mean of M-values</category>
  <category>Highly-expressed genes</category>
  <category>Differential Gene Expression</category>
  <category>RNA-seq</category>
  <guid>https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/</guid>
  <pubDate>Thu, 12 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://daianna21.github.io/daianna_blog/posts/2024-12-15-TMM_normalization/images/TODO" medium="image"/>
</item>
<item>
  <title>Exploratory Data Analysis for RNA-seq data</title>
  <dc:creator>Daianna Gonzalez-Padilla</dc:creator>
  <link>https://daianna21.github.io/daianna_blog/posts/2024-12-12-QC_and_EDA/</link>
  <description><![CDATA[ 




<p>⚠️ This page is under development.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Saying that over 50% of biological data analysis is about exploring and cleaning data is not an exaggeration. In fact, that’s the way it’s supposed to be. Biological data are inherently noisy. Not only biological differences exist between cells and samples, but all sampling and experimental procedures for data generation, introduce variability, errors, and biases into the data that we have to first spot to then clean or correct.</p>
<p>Exploratory Data Analysis (EDA) is a primordial initial step in which we get to know the overall and specific aspects of the data. This is a process where we create tons of plots to uncover and visualize the data structures, patterns, relationships, and outliers, through which we identify data issues, drive hypoteses, and guide subsequent statistical testing.</p>
<p>EDA is not a pre-established path with ordered steps to follow. What you do, what you plot depends on the particularities of the data you have and the questions you aim to answer; it is completely context dependent. Moreover, many exploratory analyses you perform depend on what previous explorations informed, adding to the global understanding of the data. However, there are basic exploratory steps that establish a foundation to move forward in your analyses.</p>
<p>In transcriptomic data analysis, EDA includes exploring the read count distribution, filtering of lowly-expressed genes and poor-quality samples/cells, determine biological and technical sources of gene expression variation, and detect confounding factors.</p>
<p>In this blog post, you will learn how to perform EDA by exploring an example gene expression data set, aiming to provide a methodological but flexible framework for you to guide your own exploratory analysis.</p>
</section>
<section id="what-youll-learn-here" class="level1">
<h1>What you’ll learn here</h1>
<ul>
<li><p>Know the type of exploratory analyses that can be done for RNA-seq data and the rationale behind them.</p></li>
<li><p>Understand the insights that can be derived from explorations and how they inform posterior analysis decisions.</p></li>
<li><p>Learn of poweful visualization tools to explore your data.</p></li>
</ul>
</section>
<section id="an-example-data-set" class="level1">
<h1>An example data set</h1>
<section id="download-data" class="level2">
<h2 class="anchored" data-anchor-id="download-data">Download data</h2>
<p>We’ll use <a href="https://rna.recount.bio"><em>recount3</em></a> <span class="citation" data-cites="leonardocollado-torres2020 wilks2021a">(Leonardo Collado-Torres 2020; Wilks et al. 2021)</span> package to download real gene expression data from a transcriptomic study, including sample metadata and quality-control (QC) metrics.</p>
<p>The chosen study can be found in the Sequence Read Archive (<a href="https://www.ncbi.nlm.nih.gov/sra">SRA</a>) under ID <code>SRP107565</code>, and it’s titled “<strong>Multiomics Profiling Establishes the Polypharmacology of FDA-Approved CDK4/6 Inhibitors and the Potential for Differential Clinical Activity”</strong> (<a href="10.1016/j.chembiol.2019.05.005">Marc Hafner et al., 2019</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recount3)</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Download all available projects in human in recount3</span></span>
<span id="cb1-4">human_projects <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">available_projects</span>()</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Download gene expression data and metadata from SRP107565 study</span></span>
<span id="cb1-7">proj_info <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(</span>
<span id="cb1-8">    human_projects,</span>
<span id="cb1-9">    project <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SRP107565"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> project_type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_sources"</span>,</span>
<span id="cb1-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recount3_url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://sciserver.org/public-data/recount3/data"</span></span>
<span id="cb1-11">)</span>
<span id="cb1-12"></span>
<span id="cb1-13">proj_info</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    project organism file_source     project_home project_type n_samples
1 SRP107565    human         sra data_sources/sra data_sources       216</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Create RangedSummarizedExperiment object to handle RNA-seq and sample data </span></span>
<span id="cb3-2">rse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_rse</span>(proj_info)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Gene expression data in assay(rse): for first 5 genes and 5 samples</span></span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assay</span>(rse)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  SRR5579425 SRR5579426 SRR5579433 SRR5579434 SRR5579435
ENSG00000278704.1          0          0          0          0          0
ENSG00000277400.1          0          0          0          0          0
ENSG00000274847.1          0          0          0          0          0
ENSG00000277428.1          0          0          0          0          0
ENSG00000276256.1          0          0          0          0          0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Sample metadata in colData(rse): for first 6 samples and 3 variables</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colData</span>(rse)[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 3 columns
             rail_id external_id       study
           &lt;integer&gt; &lt;character&gt; &lt;character&gt;
SRR5579425   1000031  SRR5579425   SRP107565
SRR5579426   1000045  SRR5579426   SRP107565
SRR5579433   1000255  SRR5579433   SRP107565
SRR5579434   1000270  SRR5579434   SRP107565
SRR5579435   1000286  SRR5579435   SRP107565
SRR5579436   1000301  SRR5579436   SRP107565</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Gene data in rowData(rse): for first 6 genes and 3 variables</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowData</span>(rse)[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>DataFrame with 6 rows and 3 columns
                    source     type bp_length
                  &lt;factor&gt; &lt;factor&gt; &lt;numeric&gt;
ENSG00000278704.1  ENSEMBL     gene      2237
ENSG00000277400.1  ENSEMBL     gene      2179
ENSG00000274847.1  ENSEMBL     gene      1599
ENSG00000277428.1  ENSEMBL     gene       101
ENSG00000276256.1  ENSEMBL     gene      2195
ENSG00000278198.1  ENSEMBL     gene      1468</code></pre>
</div>
</div>
</section>
<section id="study-design-and-aims" class="level2">
<h2 class="anchored" data-anchor-id="study-design-and-aims">Study design and aims</h2>
<p>In this study, the authors performed transcriptomic, proteomic, biochemical, and phenotypic assays to compare the activities of 3 inhibitors of cyclin-dependent kinases 4/6 (CDK4/6): abemaciclib, palbociclib, and ribociclib, which are used to treat hormone receptor-positive breast cancer. For our purposes, only transcriptomic data have been downloaded to be explored.</p>
<p>Specifically, in the transcriptomic experiment, 7 breast cancer human cell lines were drug-treated with <span style="color: #EE7621"><strong>0.3</strong></span>, <span style="color: #CD3700"><strong>1</strong></span> OR <span style="color: #8B2500"><strong>3</strong></span> µM of <span style="color: #0000FF"><strong>abemaciclib</strong></span>, <span style="color: #EE3B3B"><strong>palbociclib</strong></span>, OR <span style="color: #CDC673"><strong>ribociclib</strong></span> (OR untreated = <span style="color: #A6A6A6"><strong>control</strong></span> <strong>=</strong> drug concentration of <span style="color: #A6A6A6"><strong>0</strong></span> µM), and mRNA sequencing was performed after <strong>6</strong> OR <span style="color: #00CD66"><strong>24</strong></span> hrs of exposure. Including replicates, a total of 216 bulk samples were sequenced.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-12-QC_and_EDA/images/study_design.png" class="img-fluid figure-img" width="363"></p>
<figcaption>Ilustration taken from <strong>Figure 1A</strong> in <a href="10.1016/j.chembiol.2019.05.005">Marc Hafner et al., 2019</a>.</figcaption>
</figure>
</div>
<p>Exploring the <a href="https://www.bioconductor.org/packages/devel/bioc/vignettes/SummarizedExperiment/inst/doc/SummarizedExperiment.html"><em>RangedSummarizedExperiment</em></a> <span class="citation" data-cites="martinmorgan2017 huber2015">(Martin Morgan 2017; Huber et al. 2015)</span> object (<code>rse</code>) we just created, we can see we have raw expression data for 63,856 genes across 216 samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(rse)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 63856   216</code></pre>
</div>
</div>
<p>Processing the sample attributes contained in <code>sra.sample_attributes</code>, we can check the number of samples from each cell line, treated with each drug, at each concentration, and time. Let’s add individual columns in the sample metadata for these variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Sample attributes</span></span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sra.sample_attributes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "agent;;Abemaciclib|cell line;;BT20|dose;;0.3 uM|source_name;;BT20 breast cancer cell line|time;;6 hr"
[2] "agent;;Abemaciclib|cell line;;BT20|dose;;0.3 uM|source_name;;BT20 breast cancer cell line|time;;6 hr"
[3] "agent;;Palbociclib|cell line;;BT20|dose;;3 uM|source_name;;BT20 breast cancer cell line|time;;6 hr"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Divide each string by "|" and extract drug</span></span>
<span id="cb13-2">rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Drug <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sra.sample_attributes, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">";;"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]}) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> unname</span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Num of samples treated with each drug</span></span>
<span id="cb13-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Drug)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Abemaciclib     Control Palbociclib  Ribociclib 
         84          28          52          52 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Num of samples of each cell line</span></span>
<span id="cb15-2">rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Cell_line <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sra.sample_attributes, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">";;"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]}) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> unname</span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Cell_line)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   BT20   BT549 HCC1419 HCC1806  HS578T    MCF7    T47D 
     32      32      32      32      32      24      32 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Num of samples treated with each dose</span></span>
<span id="cb17-2">rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Concentration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sra.sample_attributes, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">";;"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]}) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> unname</span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Concentration)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0 uM 0.3 uM   1 uM   3 uM 
    28     80      4    104 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Num of samples sequenced after each time</span></span>
<span id="cb19-2">rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sra.sample_attributes, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x){<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">";;"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]}) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> unname</span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(rse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Time)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
24 hr  6 hr 
  108   108 </code></pre>
</div>
</div>
</section>
<section id="sample-variables" class="level2">
<h2 class="anchored" data-anchor-id="sample-variables">Sample variables</h2>
<p>In any EDA, we first need to know what the sample variables in the metadata stand for in order to interpret accurately any insights derived from them. A second important consideration is that, even when there are well-established QC metrics used to filter samples, exploring a broader set of them is convenient to find unexpected sample quality differences.</p>
<p>We start by defining the sample-level variables we’ll explore in our EDA.</p>
<section id="main-sample-attributes" class="level3">
<h3 class="anchored" data-anchor-id="main-sample-attributes">Main sample attributes</h3>
<ul>
<li><p><code>Cell_line</code>: name of breast cancer cell line.</p></li>
<li><p><code>Drug</code>: the drug with which a given cell line was treated.</p></li>
<li><p><code>Concentration</code>: the concentration of the drug administered to the cell line.</p></li>
<li><p><code>Time</code>: drug exposure time for each cell line.</p></li>
</ul>
</section>
<section id="quality-control-metrics" class="level3">
<h3 class="anchored" data-anchor-id="quality-control-metrics">Quality-control metrics</h3>
<p>QC metrics are measurements of a sample’s RNA composition and the mapping of its reads to a reference genome, reflecting the integrity of the cells, and the quality of the mRNA extraction, library preparation, sequencing, and read alignment steps.</p>
<p>The following metrics were collected by <em>recount3</em> through a number of tools.</p>
<ul>
<li><p>Alignment-related metrics obtained through <a href="https://github.com/alexdobin/STAR/blob/master/doc/STARmanual.pdf">STAR</a> <span class="citation" data-cites="dobin2012">(Dobin et al. 2012)</span>:</p>
<ul>
<li><p><strong><code>all_mapped_reads</code></strong>: total number of aligned reads aligned.</p></li>
<li><p><strong><code>uniquely_mapped_reads_%</code></strong>: number of reads that mapped to a single locus, of the total input reads.</p></li>
<li><p><strong><code>uniquely_mapped_reads_number</code></strong>: number of reads that mapped to a single locus.</p></li>
<li><p><strong><code>%_of_reads_mapped_to_multiple_loci</code></strong>: number of reads that mapped to multiple loci, of the input reads.</p></li>
<li><p><strong><code>number_of_reads_mapped_to_multiple_loci</code></strong>: number of reads that mapped to multiple loci.</p></li>
<li><p><strong><code>%_of_reads_unmapped:_other</code></strong>: reads that didn’t map due to no acceptable seed/windows, of all input reads.</p></li>
<li><p><strong><code>number_of_reads_unmapped:_other</code></strong>: number of reads left unmapped due to no acceptable seed/windows.</p></li>
<li><p><strong><code>%_of_reads_unmapped:_too_many_mismatches</code></strong>: Number of reads where best alignment has more mismatches than max allowed number of mismatches divided by number of input reads</p></li>
<li><p><strong><code>number_of_reads_unmapped:_too_many_mismatches</code></strong>: Number of reads where best alignment has more mismatches than max allowed number of mismatches</p></li>
<li><p><strong><code>%_of_reads_unmapped:_too_short</code></strong>: Number of reads where best alignment was shorter than min allowed mapped length divided by number of input reads.</p></li>
<li><p><strong><code>number_of_reads_unmapped:_too_short</code></strong>: Number of reads where best alignment was shorter than min allowed mapped length.</p></li>
</ul></li>
<li><p><a href="http://www.htslib.org">SAMtools</a> <span class="citation" data-cites="danecek2021">(Danecek et al. 2021)</span> statistics for chromosome-specific read mapping. Of special interest are the reads mapping to the mitochondrial and sex chromosomes (see explanation in Step X):</p>
<ul>
<li><p><strong><code>aligned_reads%.chrm</code></strong>: Percent of reads aligning to the mitochondrial genome.</p></li>
<li><p><strong><code>aligned_reads%.chrx</code></strong>: Percent of reads aligning to chromosome X.</p></li>
<li><p><strong><code>aligned_reads%.chry</code></strong>: Precent of reads aligning to chromosome Y.</p></li>
</ul></li>
<li><p>Sequencing coverage summaries in gene annotations by <a href="https://github.com/ChristopherWilks/megadepth">megadepth</a> (<code>bc</code>) <span class="citation" data-cites="wilks2020">(Wilks et al. 2020)</span> and <a href="https://subread.sourceforge.net/featureCounts.html"><em>featureCounts</em></a> <span class="citation" data-cites="liao2013">(Liao, Smyth, and Shi 2013)</span> (<code>fc</code>):</p>
<ul>
<li><p><strong><code>bc_auc.all_reads_all_bases</code></strong>: Area under coverage (total depth of coverage evaluated at all bases) for all alignments</p></li>
<li><p><strong><code>bc_auc.all_reads_annotated_bases</code></strong>: Area under coverage for all alignments, but only for bases in annotated exons</p></li>
<li><p><strong><code>bc_auc.unique_reads_all_bases</code></strong>: Area under coverage for uniquely aligned reads</p></li>
<li><p><strong><code>bc_auc.unique_reads_annotated_bases</code></strong>: Area under coverage for uniquely aligned reads, but only for bases in annotated exons.</p></li>
<li><p><strong><code>exon_fc_count_all.total</code></strong>: Total number of fragments, including multi-mappers, input to&nbsp;<code>featureCounts</code></p></li>
<li><p><strong><code>exon_fc_count_all.assigned</code></strong>: Number of fragments, including multi-mappers, assigned by&nbsp;<code>featureCounts</code>&nbsp;to an exon</p></li>
<li><p><strong><code>exon_fc_count_unique.total</code></strong>: Total number of uniquely mapping fragments input to&nbsp;<code>featureCounts</code></p></li>
<li><p><strong><code>exon_fc_count_unique.assigned</code></strong>: Number of uniquely mapping fragments assigned by&nbsp;<code>featureCounts</code>&nbsp;to an exon.</p></li>
<li><p><strong><code>gene_fc_count_all.total</code></strong>: Total number of fragments, including multi-mappers, input to&nbsp;<code>featureCounts</code></p></li>
<li><p><strong><code>gene_fc_count_all.assigned</code></strong>: Number of fragments, including multi-mappers, assigned by&nbsp;<code>featureCounts</code>&nbsp;to a gene</p></li>
<li><p><strong><code>gene_fc_count_unique.total</code></strong>: Total number of uniquely mapping fragments input to&nbsp;<code>featureCounts</code></p></li>
<li><p><strong><code>gene_fc_count_unique.assigned</code></strong>: Number of uniquely mapping fragments assigned by&nbsp;<code>featureCounts</code>&nbsp;to a gene.</p></li>
</ul></li>
</ul>
<p>For more details on the computation of these metrics please refer to <em>recount3</em> <a href="http://rna.recount.bio/docs/quality-check-fields.html">documentation</a> and the manual of each tool.</p>
</section>
</section>
</section>
<section id="exploring-count-data-todo" class="level1">
<h1>1. Exploring count data TODO</h1>
<section id="read-count-distribution-todo" class="level2">
<h2 class="anchored" data-anchor-id="read-count-distribution-todo">1.1 Read count distribution TODO</h2>
<p>A first thing to plot is the frequency of the raw counts across all genes and samples, before any transformation. This gives us an idea of how sparse the data are, i.e., if a large percentage of the counts are zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggplot2"</span>)</span>
<span id="cb21-2"></span>
<span id="cb21-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Raw counts</span></span>
<span id="cb21-4">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">raw_counts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assays</span>(rse)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>raw_counts))</span>
<span id="cb21-5">plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> raw_counts)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgray"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Raw counts"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frecuency"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()</span>
<span id="cb21-9">plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.margin =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-12-12-QC_and_EDA/index_files/figure-html/hist_raw_counts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Percentage of counts that are zero</span></span>
<span id="cb23-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assays</span>(rse)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>raw_counts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assays</span>(rse)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>raw_counts)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 61.05911</code></pre>
</div>
</div>
<p>More than 60% of the total counts across all genes and bulk samples are 0. Even though this is a large fraction, it is not surprising as we don’t expect most genes to be expressed in every condition; scRNA-seq data is even more sparse. In <strong>step 1.3</strong> we’ll deal with lowly-expressed genes …</p>
</section>
<section id="count-log-normalization-todo" class="level2">
<h2 class="anchored" data-anchor-id="count-log-normalization-todo">1.2 Count log-normalization TODO</h2>
</section>
<section id="filtering-lowly-expressed-genes-todo" class="level2">
<h2 class="anchored" data-anchor-id="filtering-lowly-expressed-genes-todo">1.3 Filtering lowly-expressed genes TODO</h2>
<p>There are multiple approaches to remove zero- and lowly-expressed genes. Here we’ll adopt the approach of removing genes with less than X CPM in at least X % samples …</p>
<p><a href="https://carpentries-incubator.github.io/rna-seq-data-for-ml/episode5.html" class="uri">https://carpentries-incubator.github.io/rna-seq-data-for-ml/episode5.html</a></p>
</section>
</section>
<section id="filtering-low-quality-samples" class="level1">
<h1>3. Filtering low-quality samples</h1>
<section id="explore-differences-in-qc-metrics-between-sample-groups" class="level2">
<h2 class="anchored" data-anchor-id="explore-differences-in-qc-metrics-between-sample-groups">3.1 Explore differences in QC metrics between sample groups</h2>
<p>Explore sex differences: sexual chr % can help to confirm the sex of the donors based on alignments to sex chromosomes.</p>
<p><a href="https://frontlinegenomics.com/how-to-ngs-quality-control/" class="uri">https://frontlinegenomics.com/how-to-ngs-quality-control/</a></p>
<p><a href="https://www.nature.com/articles/s41592-023-01946-4" class="uri">https://www.nature.com/articles/s41592-023-01946-4</a></p>
</section>
<section id="explore-relationships-between-sample-variables" class="level2">
<h2 class="anchored" data-anchor-id="explore-relationships-between-sample-variables">3.2 Explore relationships between sample variables</h2>
</section>
<section id="identify-sample-outliers-boxplots-and-pca" class="level2">
<h2 class="anchored" data-anchor-id="identify-sample-outliers-boxplots-and-pca">3.3 Identify sample outliers (Boxplots and PCA)</h2>
</section>
</section>
<section id="variable-associations-with-gene-expression" class="level1">
<h1>4. Variable associations with gene expression</h1>
<p>Identify technical sources of data variability to then reduce the systematic noise from the data.</p>
<section id="dimensionality-reduction" class="level2">
<h2 class="anchored" data-anchor-id="dimensionality-reduction">4.1 Dimensionality reduction</h2>
</section>
<section id="correlation-between-variables" class="level2">
<h2 class="anchored" data-anchor-id="correlation-between-variables">4.2 Correlation between variables</h2>
</section>
<section id="partition-of-gene-expression-variance" class="level2">
<h2 class="anchored" data-anchor-id="partition-of-gene-expression-variance">4.2 Partition of gene expression variance</h2>
</section>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>Answering these questions we may be able to formulate&nbsp;<strong>hypothesis</strong>&nbsp;that could guide future analysis or experiments.</p>
<p>EDA is extremely illuminating when performed comprehensively and you may find an answer to your data issues or lack of signals by looking back to this step.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-danecek2021" class="csl-entry">
Danecek, Petr, James K Bonfield, Jennifer Liddle, John Marshall, Valeriu Ohan, Martin O Pollard, Andrew Whitwham, et al. 2021. <span>“Twelve Years of SAMtools and BCFtools.”</span> <em>GigaScience</em> 10 (2). <a href="https://doi.org/10.1093/gigascience/giab008">https://doi.org/10.1093/gigascience/giab008</a>.
</div>
<div id="ref-dobin2012" class="csl-entry">
Dobin, Alexander, Carrie A. Davis, Felix Schlesinger, Jorg Drenkow, Chris Zaleski, Sonali Jha, Philippe Batut, Mark Chaisson, and Thomas R. Gingeras. 2012. <span>“STAR: Ultrafast Universal RNA-Seq Aligner.”</span> <em>Bioinformatics</em> 29 (1): 15–21. <a href="https://doi.org/10.1093/bioinformatics/bts635">https://doi.org/10.1093/bioinformatics/bts635</a>.
</div>
<div id="ref-huber2015" class="csl-entry">
Huber, Wolfgang, Vincent J Carey, Robert Gentleman, Simon Anders, Marc Carlson, Benilton S Carvalho, Hector Corrada Bravo, et al. 2015. <span>“Orchestrating High-Throughput Genomic Analysis with Bioconductor.”</span> <em>Nature Methods</em> 12 (2): 115–21. <a href="https://doi.org/10.1038/nmeth.3252">https://doi.org/10.1038/nmeth.3252</a>.
</div>
<div id="ref-leonardocollado-torres2020" class="csl-entry">
Leonardo Collado-Torres. 2020. <span>“Recount3.”</span> <a href="https://doi.org/10.18129/B9.BIOC.RECOUNT3">https://doi.org/10.18129/B9.BIOC.RECOUNT3</a>.
</div>
<div id="ref-liao2013" class="csl-entry">
Liao, Yang, Gordon K. Smyth, and Wei Shi. 2013. <span>“featureCounts: An Efficient General Purpose Program for Assigning Sequence Reads to Genomic Features.”</span> <em>Bioinformatics</em> 30 (7): 923–30. <a href="https://doi.org/10.1093/bioinformatics/btt656">https://doi.org/10.1093/bioinformatics/btt656</a>.
</div>
<div id="ref-martinmorgan2017" class="csl-entry">
Martin Morgan, Valerie Obenchain. 2017. <span>“SummarizedExperiment.”</span> <a href="https://doi.org/10.18129/B9.BIOC.SUMMARIZEDEXPERIMENT">https://doi.org/10.18129/B9.BIOC.SUMMARIZEDEXPERIMENT</a>.
</div>
<div id="ref-wilks2020" class="csl-entry">
Wilks, Christopher, Omar Ahmed, Daniel N. Baker, David Zhang, Leonardo Collado-Torres, and Ben Langmead. 2020. <span>“Megadepth: Efficient Coverage Quantification for BigWigs and BAMs.”</span> <a href="http://dx.doi.org/10.1101/2020.12.17.423317">http://dx.doi.org/10.1101/2020.12.17.423317</a>.
</div>
<div id="ref-wilks2021a" class="csl-entry">
Wilks, Christopher, Shijie C. Zheng, Feng Yong Chen, Rone Charles, Brad Solomon, Jonathan P. Ling, Eddie Luidy Imada, et al. 2021. <span>“Recount3: Summaries and Queries for Large-Scale RNA-Seq Expression and Splicing.”</span> <em>Genome Biology</em> 22 (1). <a href="https://doi.org/10.1186/s13059-021-02533-6">https://doi.org/10.1186/s13059-021-02533-6</a>.
</div>
</div></section></div> ]]></description>
  <category>TODO</category>
  <guid>https://daianna21.github.io/daianna_blog/posts/2024-12-12-QC_and_EDA/</guid>
  <pubDate>Thu, 12 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://daianna21.github.io/daianna_blog/posts/2024-12-12-QC_and_EDA/images/TODO" medium="image"/>
</item>
<item>
  <title>Understading coefficients in linear models fits for RNA-seq data</title>
  <dc:creator>Daianna Gonzalez-Padilla</dc:creator>
  <link>https://daianna21.github.io/daianna_blog/posts/2024-10-10-coeffs_linear_models/</link>
  <description><![CDATA[ 




<p>⚠️ This page is under development.</p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
</section>
<section id="what-youll-learn-here" class="level1">
<h1>What you’ll learn here</h1>
<ol type="1">
<li>How to interpret the coefficients in the design matrices.</li>
<li>Understand the syntaxis of interaction coefficients and learn how to interpret and utilize them.</li>
<li></li>
</ol>
</section>
<section id="an-example-data-set" class="level1">
<h1>An example data set</h1>
<p>We’ll use recount3 package to download real gene expression data from a study, including sample metadata and QC metrics that will be helpful to illustrate variable associations with gene expression data.</p>
<p>The chosen study can be found in the Sequence Read Archive (<a href="https://www.ncbi.nlm.nih.gov/sra">SRA</a>) with project ID SRP107565, and is titled “<strong>Multiomics Profiling Establishes the Polypharmacology of FDA-Approved CDK4/6 Inhibitors and the Potential for Differential Clinical Activity”.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recount3)</span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ## Download all available projects in human in recount3</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># human_projects &lt;- available_projects()</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ## Download gene expression data and metadata from </span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># proj_info &lt;- subset(</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     human_projects,</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     project == "SRP107565" &amp; project_type == "data_sources"</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># )</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rse_gene_SRP009615 &lt;- create_rse(project_info)</span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>coefficient</category>
  <category>beta</category>
  <category>interaction terms</category>
  <category>contrast</category>
  <category>multi-level variable</category>
  <guid>https://daianna21.github.io/daianna_blog/posts/2024-10-10-coeffs_linear_models/</guid>
  <pubDate>Wed, 09 Oct 2024 23:00:00 GMT</pubDate>
  <media:content url="https://daianna21.github.io/daianna_blog/posts/2024-10-10-coeffs_linear_models/images/TODO" medium="image"/>
</item>
<item>
  <title>Fisher’s exact test for enrichment analysis of gene sets</title>
  <dc:creator>Daianna Gonzalez-Padilla</dc:creator>
  <link>https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Imagine you have analyzed high-throughput omics data and have ended up with a list of candidate/interest genes. These genes could be, for instance, differentially expressed genes (DEGs), genes associated with a certain disease, genes affected by risk SNPs, markers for cell types, etc. Any list of <strong>experimentally-derived genes</strong> with biological or clinical relevance applies.</p>
<p>Now, what comes after that? If you found a few genes, you can do a little of research about them and make sense of your results, but what if you got thousands of genes? That’s not an easy task anymore and becomes unscalable. Moreover, despite each individual found gene providing valuable information, we can reveal more definite insights by studying all genes at the same time.</p>
<p>So what’s to do? We need to start thinking of these <strong>genes as a unique <u>set</u></strong> with its own properties, and ask questions such as <em>what do these genes have in common?</em> <em>what makes them being involved or affected by the condition under study</em>, and <em>what does that imply for cell functionality?</em></p>
<p><strong>Functional enrichment analysis</strong> based on the <span style="background-color: #FFF68F"><strong>one-sided Fisher’s exact test</strong></span> (aka over-representation analysis (ORA) in the field) aims to test whether <span style="color: #EE3A8C"><strong>our genes <u>as a set</u></strong></span> are associated with certain cellular properties or functions by assessing if <em>sets of known genes that share biological activities or attributes</em> (<span style="color: #00C5CD"><strong>functional gene sets</strong></span>), have a statistically significant <strong>large overlap</strong> with our genes, i.e., if such functional gene sets are, what we call <u><strong>over-represented</strong></u> (or <u><strong>enriched</strong></u>, which is the same), among our genes. Stay on this post to learn more about how this test operates and how to understand and apply it to analyze sets of genes.</p>
</section>
<section id="what-youll-learn-here" class="level1">
<h1>What you’ll learn here</h1>
<ol type="1">
<li>Comprehend the purpose and the basics of a functional enrichment analysis based on gene sets.</li>
<li>Understand the probabilistic and statistic foundations of the Fisher’s exact test and interpret it with gene sets.</li>
<li>Clarify the required input gene sets to correctly perform this analysis.</li>
<li>Learn how to run this test using R and understand the outputs.</li>
<li>Differentiate <strong>enrichment</strong> vs.&nbsp;<strong>depletion</strong> when performing this test.</li>
</ol>
</section>
<section id="the-fishers-exact-test" class="level1">
<h1>The Fisher’s exact test</h1>
<p>This is a classical statistical test based on the hypergeometric distribution (thus also called <strong>hypergeometric test</strong>) used to assess if there is a significant association between two categorical binary variables, such as differential expression of the genes and their involvement in a specific biological process. The association of the two variables is calculated in terms of the <strong>intersection size</strong> between their elements.</p>
<p>For illustrative purposes to show the application of this test in gene set-based functional enrichment analysis, imagine we have run a differential gene expression analysis (DGE) for a condition and have obtained a list of DEGs. As part of downstream analyses, we want to know how many of such DEGs participate in a specific biological process of interest and if that number significantly deviates from what is expected by chance.</p>
<p>In the next sections we’ll go into more detail on how to demarcate the required sets of genes for this test, represent them in contingency tables, assess enrichment (or depletion) in R, and how to interpret this test and its results.</p>
<section id="creating-and-understanding-contingency-tables" class="level2">
<h2 class="anchored" data-anchor-id="creating-and-understanding-contingency-tables">1. Creating and understanding contingency tables</h2>
<p>The following are the required gene sets and their specifications. Please note that when referring to a set of genes, we are specifically referring to the set of gene IDs; that all we need to run this test!</p>
<ul>
<li><p><span style="color: #595959"><strong>Gene universe/background</strong></span>: these are all the genes that were experimentally measured and interrogated to generate the list of interest genes (our gene set). In our hypothetical scenario this is given by all genes that were assessed for DGE.</p>
<p>→ Let’s denote as “DE” the variable defining if a gene is differentially expressed (<span style="color: #EE3A8C"><strong>DEG</strong></span>) or not (<span style="color: #D8BFD8"><strong>non-DEG</strong></span>).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How to find my gene universe?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since we are testing enrichment of functional gene sets among our DEGs, and not the other way around, our “gene universe” must correspond to the total number of genes for which we assessed DGE. Within those genes, categorized by DE, we search for genes contained in a functional set.</p>
</div>
</div></li>
<li><p><span style="color: #EE3A8C"><strong>Experimentally-derived gene set</strong></span> (our gene set): a list of interest genes derived from our experimental measurements and analyses, and to which we want to assign biological meanings. In our example case this is the list of DEGs from the <span style="color: #595959"><strong>gene universe</strong></span>.</p></li>
<li><p><span style="color: #00C5CD"><strong>Functional gene set</strong></span>: a set of genes with shared biological attributes (e.g.&nbsp;participation in a pathway, implication in the same biological process, sharing a molecular activity, or if their gene products are located in a certain cell compartment). Conveniently, functional gene sets are accessible via knowledgebases such as <a href="https://geneontology.org">Gene Ontology (GO)</a> <span class="citation" data-cites="ashburner2000">(Ashburner et al. 2000)</span> and the <a href="https://www.kegg.jp">Kyoto encyclopedia of genes and genomes (KEGG)</a> <span class="citation" data-cites="kanehisa2000">(Kanehisa 2000)</span>.</p>
<p>→ Let’s denote as “BP” the variable determining if a gene is involved in the biological process (<span style="color: #00C5CD"><strong>BP+</strong></span>) or not (<span style="color: #C1CDCD"><strong>BP-</strong></span>).</p></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>There may be cases where you have some genes in your functional set that are not present in the gene universe. Since they were not tested for DGE we can’t categorize them as DEGs or non-DEGs. Despite this, given that we often assume most genes are non-DEGs, you can either consider them as such or exclude them from the analysis to avoid introducing ambiguous information.</p>
</div>
</div>
<p>Fisher’s exact test aims to detect functional gene sets whose genes are unusually represented (<strong>enriched</strong>/<strong>over-represented</strong> or <strong>under-represented</strong>) in our set of interest genes. That is, if there’s a large (or small) overlap between the genes of the functional set (BP+ genes in this case) and the genes we classified as relevant from our data (DEGs in this case).</p>
<p>Following our hypothetical example, let’s suppose we have analyzed DGE for a total of 32 genes and of these 15 were <span style="color: #EE3A8C"><strong>DEGs</strong></span>. Suppose we have a functional gene set containing 12 genes involved in a biological process (<span style="color: #00C5CD"><strong>BP+</strong></span>) and of these 9 were DEGs. Having identified such gene sets, we proceed to create a <strong>2x2 contingency table</strong> showing the number of genes that belong to each category for each variable.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/contingency_table_3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="421"></p>
</figure>
</div>
<p>The numbers of <span style="color: #EE3A8C"><strong>DEGs</strong></span>, <span style="color: #D8BFD8"><strong>non-DEGs</strong></span>, <span style="color: #00C5CD"><strong>BP+</strong></span> genes, and <span style="color: #C1CDCD"><strong>BP-</strong></span> genes are called the <em>marginal values</em>, as they lie on the periphery of this 2x2 table. The middle cells (<img src="https://latex.codecogs.com/png.latex?a">’s) are the <em>joint values</em>, as they represent the overlap between the categories of the two variables.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that by modifying only one joint value, say <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D">, all the remaining joint values will be already determined since the marginals are fixed. In that way we can describe whole contingency tables with only their <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D"> corner values.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Define example gene universe: 32 total genes analyzed </span></span>
<span id="cb1-2">gene_universe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Srsf5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gm15387"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mprip"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pim1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bnip3l"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Efr3a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marco"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tuba1a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gsk3a"</span>,</span>
<span id="cb1-3">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dap3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tmod3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dnajb1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tulp4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lsm14b"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Khdrbs2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mfsd9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ufd1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ypel5"</span>,</span>
<span id="cb1-4">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rbm3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dnajc28"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Msrb2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Memo1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cebpg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Flywch1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ip6k1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nudt4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Csnk1e"</span>,</span>
<span id="cb1-5">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Qsox2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gm43517"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rhbdf2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fbxw11"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hmgxb4"</span>) </span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(gene_universe)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 32</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Define 15 DEGs from universe</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">08122024</span>)</span>
<span id="cb3-3">DEGs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(gene_universe, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-4">DEGs</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Srsf5"   "Flywch1" "Ip6k1"   "Cebpg"   "Nudt4"   "Ypel5"   "Marco"  
 [8] "Csnk1e"  "Qsox2"   "Gsk3a"   "Dap3"    "Tuba1a"  "Efr3a"   "Hmgxb4" 
[15] "Gm15387"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(DEGs))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Remaining 17 non-DEGs</span></span>
<span id="cb7-2">non_DEGs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gene_universe[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>gene_universe <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> DEGs]</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Functional set of 12 BP+ genes (with 9 being DEGs)</span></span>
<span id="cb7-5">funct_gene_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(DEGs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(non_DEGs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span>
<span id="cb7-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(funct_gene_set))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## BP- genes: genes in universe not in functional set</span></span>
<span id="cb9-2">genes_not_func_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gene_universe[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>gene_universe <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> funct_gene_set]</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Intersections:</span></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. DEGs and BP+ genes</span></span>
<span id="cb9-6">DEGs_in_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(DEGs, funct_gene_set)</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. non-DEGs and BP+ genes</span></span>
<span id="cb9-9">non_DEGs_in_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(non_DEGs, funct_gene_set)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. DEGs and BP- genes</span></span>
<span id="cb9-12">DEGs_not_in_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(DEGs, genes_not_func_set)</span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. non-DEGs and BP- genes</span></span>
<span id="cb9-15">non_DEGs_not_in_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(non_DEGs, genes_not_func_set)</span>
<span id="cb9-16">  </span>
<span id="cb9-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Create contingency table</span></span>
<span id="cb9-18">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(DEGs_in_set), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(DEGs_not_in_set), </span>
<span id="cb9-19">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(non_DEGs_in_set), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(non_DEGs_not_in_set)), </span>
<span id="cb9-20">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-21">m</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    9    6
[2,]    3   14</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When we test for “association” between DE and BP note that it could be either <strong>positive</strong> or <strong>negative</strong>, with the former implying a larger overlap between DEGs and BP+ genes, and thus corresponding to <strong>enrichment</strong>, and the latter implying a smaller overlap and thus meaning <strong>depletion</strong>. We’ll also delve into the statistical implications of each type of association in the next sections.</p>
</div>
</div>
</section>
<section id="testing-for-gene-set-enrichment" class="level2">
<h2 class="anchored" data-anchor-id="testing-for-gene-set-enrichment">2. Testing for gene-set enrichment</h2>
<p>The Fisher’s exact test is used to determine the <span style="background-color: #FFFFE0">probability of observing the joint value <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D"> in our table or a more extreme value</span> (for contingency tables with the same fixed marginal totals) under the <strong>null hypothesis (</strong><img src="https://latex.codecogs.com/png.latex?H_0"><strong>)</strong> that there’s <u>no association between the categorical variables</u>, i.e., that they are independent. These probabilities are referred to as <em>p</em>-values. Smaller probabilities offer strong evidence against the null hypothesis, which is translated into statistical evidence to accept the <strong>alternative hypothesis (</strong><img src="https://latex.codecogs.com/png.latex?H_A"><strong>)</strong> of <u>association between the two variables</u>.</p>
<p>This is how it operates:</p>
<ol type="1">
<li>Given the fixed marginal totals, we first we compute all possible contingency tables by enumerating all possible joint values <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D">: in this case from 0 to 12, which are the minimum and maximum number of genes that can be both <span style="color: #EE3A8C"><strong>DEGs</strong></span> and <span style="color: #00C5CD"><strong>BP+</strong></span>, respectively.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/all_tables.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin: 0px" width="449"></p>
</figure>
</div>
<div style="background-color:#F2F2F2; padding: 15px; margin-bottom:0px">
<div class="line-block">❗️ The top left cell (<img src="https://latex.codecogs.com/png.latex?a_%7B11%7D">) of each table always corresponds to the joint value positive for both variables under examination (<span style="color: #00C5CD"><strong>BP+</strong></span> <span style="color: #EE3A8C"><strong>DEGs</strong></span>).</div>
</div>
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/white_space.png" style="margin: 0px" width="30" height="4"></p>
<ol start="2" type="1">
<li><p>Then we estimate the probability of having such joint values in each contingency table under the null hypothesis. To do that we need to calculate the number of ways of obtaining the joint values by randomness in the gene selection process. Only 3 values need to be estimated for that:</p>
<ol type="1">
<li><p>The ways of selecting <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D%20+%20a_%7B12%7D"> = 15 genes (corresponding to the number of <span style="color: #EE3A8C"><strong>DEGs</strong></span>) without replacement from the total genes in the <span style="color: #595959"><strong>gene universe</strong></span>: <img src="https://latex.codecogs.com/png.latex?%7Ba_%7B11%7D%20+%20a_%7B12%7D%20+%20a_%7B21%7D%20+%20a_%7B22%7D%7D%20%5Cchoose%20a_%7B11%7D%20+%20a_%7B12%7D"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/32_choose_15.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="451"></p>
</figure>
</div></li>
<li><p>The ways of selecting <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D"> = 9 genes (number of <span style="color: #00C5CD"><strong>BP+</strong></span> <span style="color: #EE3A8C"><strong>DEGs</strong></span>) without replacement out of the <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D%20+%20a_%7B21%7D"> = 12 genes in the functional set (<span style="color: #00C5CD"><strong>BP+</strong></span> genes): <img src="https://latex.codecogs.com/png.latex?%7B%7Ba_%7B11%7D%20+%20a_%7B21%7D%7D%20%5Cchoose%20a_%7B11%7D%7D"></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/12_choose_9.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="351"></p>
</figure>
</div></li>
<li><p>The ways of selecting <img src="https://latex.codecogs.com/png.latex?a_%7B12%7D"> = 6 genes (number of <span style="color: #C1CDCD"><strong>BP-</strong></span> <span style="color: #EE3A8C"><strong>DEGs</strong></span>) without replacement out of the <img src="https://latex.codecogs.com/png.latex?a_%7B12%7D+a_%7B22%7D"> = 20 genes not in the functional set (<span style="color: #C1CDCD"><strong>BP-</strong></span> genes): <img src="https://latex.codecogs.com/png.latex?%7Ba_%7B12%7D+a_%7B22%7D%7D%5Cchoose%7Ba_%7B12%7D%7D"></p></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/20_choose_6.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="355"></p>
</figure>
</div></li>
</ol>
<p>With these 3 values we define the probability of each table arrangement by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap=%5Cfrac%7B%7B%7Ba_%7B11%7D+a_%7B21%7D%7D%5Cchoose%20a_%7B11%7D%7D%20%5Ctimes%20%7B%7Ba_%7B12%7D+a_%7B22%7D%7D%5Cchoose%7Ba_%7B12%7D%7D%7D%20%7D%7B%7Ba_%7B11%7D+a_%7B12%7D+a_%7B21%7D+a_%7B22%7D%7D%5Cchoose%7Ba_%7B11%7D+a_%7B12%7D%7D%7D%0A"></p>
<p>This is precisely the probability function for the <a href="https://www.pathwaycommons.org/guide/primers/statistics/distributions/#hypergeometric">hypergeometric distribution</a>, used for sampling without replacement and which we use to test the null hypothesis.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(x)=%5Cfrac%7B%7Bm%20%5Cchoose%20x%7D%20%7Bn%20%5Cchoose%20%7Bk-x%7D%7D%7D%7B%7Bm+n%7D%5Cchoose%20k%7D"></p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?k"> is the sample size (number of <span style="color: #EE3A8C"><strong>DEGs</strong></span>) = <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D%20+%20a_%7B12%7D"> = 15</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?m"> is the number of successes in the population (number of <span style="color: #00C5CD"><strong>BP+</strong></span> genes) = <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D%20+%20a_%7B21%7D"> = 12</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?n"> is the number of failures in the population (number of <span style="color: #C1CDCD"><strong>BP-</strong></span> genes) = <img src="https://latex.codecogs.com/png.latex?a_%7B12%7D%20+%20a_%7B22%7D"> = 20</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?x"> is the number of successes in the sample (number of <span style="color: #00C5CD"><strong>BP+</strong></span> among <span style="color: #EE3A8C"><strong>DEGs</strong></span>) = <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D"> = 9</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?k-x"> is the number of failures in the sample (number of <span style="color: #C1CDCD"><strong>BP-</strong></span> among <span style="color: #EE3A8C"><strong>DEGs</strong></span>) = <img src="https://latex.codecogs.com/png.latex?a_%7B12%7D"> = 6</p></li>
<li><p><img src="https://latex.codecogs.com/png.latex?m+n"> is the population size (size of <span style="color: #595959"><strong>gene universe</strong></span>) = <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D%20+%20a_%7B12%7D%20+%20a_%7B21%7D%20+%20a_%7B22%7D"> = 32</p></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How to interpret the above formula?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Basically, we are quantifying the number of ways of obtaining a sample of size <img src="https://latex.codecogs.com/png.latex?k"> composed of <img src="https://latex.codecogs.com/png.latex?x"> successes from a total of <img src="https://latex.codecogs.com/png.latex?m"> successes in the population AND the remaining <img src="https://latex.codecogs.com/png.latex?k-x"> elements as failures from a total of <img src="https://latex.codecogs.com/png.latex?n"> failures in the population; of all possible ways of randomly selecting <img src="https://latex.codecogs.com/png.latex?k"> elements from the population.</p>
</div>
</div>
<p>Transferred to our scenario, think of it as having 15 chances to select genes without replacement from the universe that contains both <span style="color: #00C5CD"><strong>BP+</strong></span> and <span style="color: #C1CDCD"><strong>BP-</strong></span> genes. Repeat the experiment multiple times and count the times that 9 of the 15 genes you selected were <span style="color: #00C5CD"><strong>BP+</strong></span> (out of 12 BP+ genes in total) and the remaining 6 genes <span style="color: #C1CDCD"><strong>BP-</strong></span> (out of 20 BP- genes in total), over the number of experiments; that approximates your probability. This probability describes how likely it is to observe your table numbers (<strong>9</strong> <span style="color: #00C5CD"><strong>BP+</strong></span> and <strong>6</strong> <span style="color: #C1CDCD"><strong>BP-</strong></span> genes in the sample of <strong>15</strong> <span style="color: #EE3A8C"><strong>DEGs</strong></span>) just by chance.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/experiment2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="597"></p>
</figure>
</div>
<p>For our actual contingency table <img src="https://latex.codecogs.com/png.latex?p(x=9)=%5Cfrac%7B%7B12%20%5Cchoose%209%7D%20%5Ctimes%20%7B20%5Cchoose6%7D%7D%7B32%5Cchoose15%7D">:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Calculate manually</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">choose</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">choose</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">choose</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01507311</code></pre>
</div>
</div>
<p>Let’s use <code>dhyper()</code> to obtain the density function for the hypergeometric distribution with the above parameters and confirm we get the same probability for <img src="https://latex.codecogs.com/png.latex?x"> = 9.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Hypergeometric distribution parameters:</span></span>
<span id="cb13-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  -x = 0:12 (a11 for all possible tables)</span></span>
<span id="cb13-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  -m = 12 </span></span>
<span id="cb13-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  -n = 20</span></span>
<span id="cb13-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##  -k = 15</span></span>
<span id="cb13-8"></span>
<span id="cb13-9">probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dhyper</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb13-10">xs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb13-11">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>xs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p=</span>probabilities)</span>
<span id="cb13-12">df </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    x            p
1   0 2.740565e-05
2   1 8.221696e-04
3   2 9.043865e-03
4   3 4.898760e-02
5   4 1.469628e-01
6   5 2.586545e-01
7   6 2.743306e-01
8   7 1.763554e-01
9   8 6.782899e-02
10  9 1.507311e-02
11 10 1.808773e-03
12 11 1.027712e-04
13 12 2.015121e-06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bar plot</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span>p)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-3">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb15-4">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beige"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-5">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(probabilities, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb15-6">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>probabilities, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-7">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of BP+ DEGs"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probability"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="one-sided-test" class="level3">
<h3 class="anchored" data-anchor-id="one-sided-test"><strong>One-sided test</strong></h3>
<p>As mentioned before, we are not only interested in the probability of the observed contingency table but also in those for more extreme contingency tables, i.e., tables with greater <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D">’s.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/all_tables_extreme.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="494"></p>
</figure>
</div>
<p>We add the probability of the actual table + the probabilities for such more extreme tables in order to get the probability of observing 9 or more <span style="color: #EE3A8C"><strong>DEGs</strong></span> that are <span style="color: #00C5CD"><strong>BP+</strong></span> under the null hypothesis:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## p(x&gt;=9)</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(probabilities[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01698667</code></pre>
</div>
</div>
<p>Since <em>p</em> &lt;0.05 we reject the null hypothesis and accept that there’s an enrichment of <span style="color: #00C5CD"><strong>BP+</strong></span> genes amongst our <span style="color: #EE3A8C"><strong>DEGs</strong></span>, and hence the biological process has a significant positive association with differential gene expression.</p>
<p>This is called a <strong>one-sided Fisher’s exact test</strong> as we are evaluating probabilities of extreme values on only one side of the density curve (values <img src="https://latex.codecogs.com/png.latex?a_%7B11%7D">≥9 for enrichment; see plot below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Color in red those x&gt;=9</span></span>
<span id="cb18-2">colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beige'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb18-3">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> colors</span>
<span id="cb18-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>colors)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-5">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-6">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span> colors, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-7">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(probabilities, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb18-8">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>probabilities, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-9">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of BP+ DEGs"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probability"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We obtain the same result with <code>fisher.test(alternative = ”greater”)</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fisher.test</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alternative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greater"</span>) </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Fisher's Exact Test for Count Data

data:  m
p-value = 0.01699
alternative hypothesis: true odds ratio is greater than 1
95 percent confidence interval:
 1.402791      Inf
sample estimates:
odds ratio 
  6.529133 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that the results of this test are the same for the transposed matrix, so if we put one or the other variable in columns or rows doesn’t affect as long as the first element of the table is the number of successes in the sample (BP+ DEGs).&nbsp;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Matrix</span></span>
<span id="cb21-2">m</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    9    6
[2,]    3   14</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Transposed matrix</span></span>
<span id="cb23-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(m)     </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    9    3
[2,]    6   14</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Fisher test on t(m)</span></span>
<span id="cb25-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fisher.test</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(m), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alternative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"greater"</span>)  </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Fisher's Exact Test for Count Data

data:  t(m)
p-value = 0.01699
alternative hypothesis: true odds ratio is greater than 1
95 percent confidence interval:
 1.402791      Inf
sample estimates:
odds ratio 
  6.529133 </code></pre>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="assessing-gene-set-depletion" class="level2">
<h2 class="anchored" data-anchor-id="assessing-gene-set-depletion">Assessing gene-set depletion?</h2>
<p>What if we are not only interested in assessing the over-representation of gene sets in our experimentally-derived gene list, but also in their under-representation? There may be fewer <span style="color: #00C5CD"><strong>BP+</strong></span> genes in the group of <span style="color: #EE3A8C"><strong>DEGs</strong></span> than expected by chance. In such case we’d be assessing for a negative association between the variables and we need to sum the probabilities of our table and those that are less extreme.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Color in red x&lt;=9</span></span>
<span id="cb27-2">colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beige'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb27-3">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> colors</span>
<span id="cb27-4"></span>
<span id="cb27-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>colors)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-6">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-7">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span> colors, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-8">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(probabilities, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb27-9">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>probabilities, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-10">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of BP+ DEGs"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probability"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## p-value:</span></span>
<span id="cb28-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(probabilities[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9980864</code></pre>
</div>
</div>
<p>In this case we use <code>fisher.test(alternative = ”less”)</code> and obtain the same <em>p</em>-value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Same with fisher.test(alternative = "less")</span></span>
<span id="cb30-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fisher.test</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alternative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"less"</span>)    </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Fisher's Exact Test for Count Data

data:  m
p-value = 0.9981
alternative hypothesis: true odds ratio is less than 1
95 percent confidence interval:
  0.00000 37.74069
sample estimates:
odds ratio 
  6.529133 </code></pre>
</div>
</div>
</section>
<section id="two-sided-test" class="level2">
<h2 class="anchored" data-anchor-id="two-sided-test"><strong>Two-sided test</strong></h2>
<p>The <strong>two-sided Fisher’s exact test</strong> is based on both tails of the hypergeometric distribution and is thus used when we want to evaluate if there’s any association between the variables irrespective of the sign (assessing for both enrichment and depletion).</p>
<p>One approach to account for extreme values on both sides is to double the sum of the extreme tables’ probabilities on one side (i.e.&nbsp;the one-sided <em>p</em>-value):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## p-value</span></span>
<span id="cb32-2"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(probabilities[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03397334</code></pre>
</div>
</div>
<p>A second approach is to add the one-sided <em>p</em>-value + all the probabilities that are less than or equal to the one for the observed table (probabilities for <img src="https://latex.codecogs.com/png.latex?x"> = 0,1, and 2 in this example; see plot below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## p-value</span></span>
<span id="cb34-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(probabilities[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(probabilities[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02688011</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Two-sided test</span></span>
<span id="cb36-2">colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beige'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb36-3">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> colors</span>
<span id="cb36-4"></span>
<span id="cb36-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>colors)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-6">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-7">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span> colors, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-8">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">signif</span>(probabilities, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb36-9">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>probabilities, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-10">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of BP+ DEGs"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probability"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We get the same result using <code>fisher.test(alternative = ”two.sided”)</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fisher.test</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alternative =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two.sided"</span>)   </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Fisher's Exact Test for Count Data

data:  m
p-value = 0.02688
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
  1.120742 51.566943
sample estimates:
odds ratio 
  6.529133 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What’s the odds ratio?
</div>
</div>
<div class="callout-body-container callout-body">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/odds_m.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin: 0px" width="334"></p>
</figure>
</div>
<ul>
<li><p>Odds of <span style="color: #EE3A8C"><strong>DE</strong></span> in <span style="color: #00C5CD"><strong>BP+</strong></span> genes = <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B11%7D%7D%7Ba_%7B21%7D%7D">: how many times it is more likely to be a DEG than a non-DEG among the genes in the functional set.</p></li>
<li><p>Odds of <span style="color: #EE3A8C"><strong>DE</strong></span> in <span style="color: #C1CDCD"><strong>BP-</strong></span> genes =<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B12%7D%7D%7Ba_%7B22%7D%7D">: how many times it is more likely to be a DEG than a non-DEG among the genes outside the functional set.</p></li>
<li><p><strong>Odds ratio (OR) of <span style="color: #EE3A8C">DE</span> in <span style="color: #00C5CD">BP+</span> vs.&nbsp;<span style="color: #C1CDCD">BP-</span> genes</strong> = <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B11%7D%7D%7Ba_%7B21%7D%7D%20/%20%5Cfrac%7Ba_%7B12%7D%7D%7Ba_%7B22%7D%7D"> = <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B11%7D%5Ctimes%20a_%7B22%7D%7D%7Ba_%7B12%7D%20%5Ctimes%20a_%7B21%7D%7D">: how many times it is more probable to be a DEG among the BP+ genes than among BP- genes.</p></li>
</ul>
<p>Same thing if we interchange the columns and rows:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/odds_tm.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin: 0px" width="331"></p>
</figure>
</div>
<ul>
<li><p>Odds of being <span style="color: #00C5CD"><strong>BP+</strong></span> in <span style="color: #EE3A8C"><strong>DEGs</strong></span> = <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B11%7D%7D%7Ba_%7B12%7D%7D"></p></li>
<li><p>Odds of being <span style="color: #00C5CD"><strong>BP+</strong></span> in <span style="color: #D8BFD8"><strong>non-DEGs</strong></span> = <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B21%7D%7D%7Ba_%7B22%7D%7D"></p></li>
<li><p><strong>Odds ratio =</strong> odds of being BP+ in DEGs vs.&nbsp;non-DEGs: <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B11%7D%7D%7Ba_%7B12%7D%7D%20/%20%5Cfrac%7Ba_%7B21%7D%7D%7Ba_%7B22%7D%7D"> =<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Ba_%7B11%7D%5Ctimes%20a_%7B22%7D%7D%7Ba_%7B12%7D%20%5Ctimes%20a_%7B21%7D%7D"></p></li>
</ul>
<p>If OR&gt;1 then it is more likely to be a <span style="color: #00C5CD"><strong>BP+</strong></span> gene among the group of <span style="color: #EE3A8C"><strong>DEGs</strong></span>→ <strong>positive association</strong> between the two variables.</p>
<p>If OR&lt;1 then is more likely to be a <span style="color: #00C5CD"><strong>BP+</strong></span> gene among the group of <span style="color: #D8BFD8"><strong>non-DEGs</strong></span>→ <strong>negative association</strong> between the two variables.</p>
<p>If OR≠1 then is either more or less likely to be a <span style="color: #00C5CD"><strong>BP+</strong></span> gene among the group of <span style="color: #EE3A8C"><strong>DEGs</strong></span> → there is an <strong>association</strong> between the two variables.</p>
<p>The OR returned by <code>fisher.test()</code> differs slightly from this formula as they are calculated based on the conditional maximum-likelihood estimate.</p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>The one-sided Fisher’s exact test is a popular method used in omics to assess the enrichment of gene sets of interest in a list of genes resulting from high-throughput experimental measurements, drawing potential biological implications from such assays. Its fast running times, and simple input requirements and statistical basis make it user-friendly and straightforward to implement. However, there are clarifications and caveats to consider:</p>
<ol type="1">
<li><p>Even though here we focused on the Fisher’s exact test, plenty of other methodological and statistical strategies for gene set functional enrichment have been proposed <span class="citation" data-cites="khatri2012">(Khatri, Sirota, and Butte 2012)</span> &amp; <span class="citation" data-cites="geistlinger2020">(Geistlinger et al. 2020)</span>.</p></li>
<li><p>Here we exemplified the execution of this test with DEGs and functional gene sets, but this over-representation approach doesn’t restrict the analysis to them, not even to genes. You can conceive the enormous applicability of this test for any overlapping sets of biological features/molecules.</p></li>
<li><p>Intrinsic limitations of this test have been noted:</p>
<p>i) This test does restrict the analysis to overlaps between feature IDs and treats them all equally, without being able to incorporate relevant and informative feature metrics, compared to functional class scoring (FCS) methods such as the gene set enrichment analysis (GSEA) developed in <span class="citation" data-cites="subramanian2005">(Subramanian et al. 2005)</span>.</p>
<p>ii) When analyzing genes we assume they are independent but that’s not necessarily true. Correlation between gene expression of functionally-related genes inflates the number of false enrichment discoveries <span class="citation" data-cites="goeman2007">(Goeman and Bühlmann 2007)</span>.</p>
<p>In spite of critics, ORA has proven to yield biologically relevant results and is widely recommended <span class="citation" data-cites="geistlinger2020">(Geistlinger et al. 2020)</span>.</p></li>
<li><p>Last reminder, Fisher’s exact test works to test enrichment but also depletion. Careful with what you are trying to answer, how you run this analysis and how you interpret your results!</p></li>
</ol>
<p>Hopefully at this point you have a clearer understanding around this test and feel more prepared to decide if this is appropriate to test your hypothesis based on your data.</p>
</section>
<section id="relevant-links" class="level1">
<h1>Relevant links</h1>
<div style="background-color: #F8F8FF;  padding: 14px; margin-left: 0px; margin-bottom: 1px; font-size: 15px; line-height: 1.3; margin-bottom:15px">
<div class="line-block">📑 <strong>Bioconductor 2018 Functional Enrichment Analysis Workshop:</strong><br>
Ludwig Geistlinger &amp; Levi Waldron. <a href="https://bioconductor.github.io/BiocWorkshops/functional-enrichment-analysis-of-high-throughput-omics-data.html">Chapter 9: Functional enrichment analysis of high-throughput omics data</a>.</div>
</div>
<div style="background-color: #F8F8FF;  padding: 14px; margin-left: 0px; margin-bottom: 1px; font-size: 15px; line-height: 1.3; margin-bottom:15px">
<div class="line-block">📑 <strong>Bioconductor 2020 Functional Enrichment Analysis Workshop:</strong><br>
Ludwig Geistlinger &amp; Levi Waldron. <a href="https://waldronlab.io/enrichOmics/articles/Geistlinger_enrichOmics.html">Functional enrichment analysis of high-throughput omics data</a>.</div>
</div>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-ashburner2000" class="csl-entry">
Ashburner, Michael, Catherine A. Ball, Judith A. Blake, David Botstein, Heather Butler, J. Michael Cherry, Allan P. Davis, et al. 2000. <span>“Gene Ontology: Tool for the Unification of Biology.”</span> <em>Nature Genetics</em> 25 (1): 25–29. <a href="https://doi.org/10.1038/75556">https://doi.org/10.1038/75556</a>.
</div>
<div id="ref-geistlinger2020" class="csl-entry">
Geistlinger, Ludwig, Gergely Csaba, Mara Santarelli, Marcel Ramos, Lucas Schiffer, Nitesh Turaga, Charity Law, et al. 2020. <span>“Toward a Gold Standard for Benchmarking Gene Set Enrichment Analysis.”</span> <em>Briefings in Bioinformatics</em> 22 (1): 545–56. <a href="https://doi.org/10.1093/bib/bbz158">https://doi.org/10.1093/bib/bbz158</a>.
</div>
<div id="ref-goeman2007" class="csl-entry">
Goeman, Jelle J., and Peter Bühlmann. 2007. <span>“Analyzing Gene Expression Data in Terms of Gene Sets: Methodological Issues.”</span> <em>Bioinformatics</em> 23 (8): 980–87. <a href="https://doi.org/10.1093/bioinformatics/btm051">https://doi.org/10.1093/bioinformatics/btm051</a>.
</div>
<div id="ref-kanehisa2000" class="csl-entry">
Kanehisa, M. 2000. <span>“KEGG: Kyoto Encyclopedia of Genes and Genomes.”</span> <em>Nucleic Acids Research</em> 28 (1): 27–30. <a href="https://doi.org/10.1093/nar/28.1.27">https://doi.org/10.1093/nar/28.1.27</a>.
</div>
<div id="ref-khatri2012" class="csl-entry">
Khatri, Purvesh, Marina Sirota, and Atul J. Butte. 2012. <span>“Ten Years of Pathway Analysis: Current Approaches and Outstanding Challenges.”</span> Edited by Christos A. Ouzounis. <em>PLoS Computational Biology</em> 8 (2): e1002375. <a href="https://doi.org/10.1371/journal.pcbi.1002375">https://doi.org/10.1371/journal.pcbi.1002375</a>.
</div>
<div id="ref-subramanian2005" class="csl-entry">
Subramanian, Aravind, Pablo Tamayo, Vamsi K. Mootha, Sayan Mukherjee, Benjamin L. Ebert, Michael A. Gillette, Amanda Paulovich, et al. 2005. <span>“Gene Set Enrichment Analysis: A Knowledge-Based Approach for Interpreting Genome-Wide Expression Profiles.”</span> <em>Proceedings of the National Academy of Sciences</em> 102 (43): 15545–50. <a href="https://doi.org/10.1073/pnas.0506580102">https://doi.org/10.1073/pnas.0506580102</a>.
</div>
</div></section></div> ]]></description>
  <category>Fisher&#39;s exact test</category>
  <category>overrepresentation</category>
  <category>ORA</category>
  <category>enrichment</category>
  <category>Gene Set Enrichment Analysis</category>
  <category>GO</category>
  <category>KEGG</category>
  <category>Functional enrichment</category>
  <guid>https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/</guid>
  <pubDate>Sun, 18 Aug 2024 23:00:00 GMT</pubDate>
  <media:content url="https://daianna21.github.io/daianna_blog/posts/2024-08-11-Fisher_test/images/Fishers_logo.png" medium="image" type="image/png" height="78" width="144"/>
</item>
<item>
  <title>MAGMA: How does the Gene and the Gene-Set analysis operate?</title>
  <dc:creator>Daianna Gonzalez-Padilla</dc:creator>
  <link>https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>MAGMA&nbsp;stands for&nbsp;<strong>Multi-marker Analysis of GenoMic Annotation</strong>&nbsp;and is a computational tool for the analysis of the joint effect of multiple genetic markers on a phenotype based on Genome-Wide Association Study (GWAS) data. MAGMA constitutes a flexible and generalizable approach to assess the&nbsp;<strong>association</strong>&nbsp;of&nbsp;<u><strong>individual genes</strong></u>&nbsp;or&nbsp;<u><strong>gene-sets</strong></u>&nbsp;with a&nbsp;<strong>phenotype</strong>&nbsp;based on the associations that the&nbsp;<u><strong>SNPs</strong></u>&nbsp;of the genes have with the same phenotype.</p>
<p>This is a commonly used method that you’ll likely find implemented while reading about GWASes or that you’ll need to run if working with genetic variant associations and gene/gene-set analysis, so let’s see how it works.</p>
</section>
<section id="what-youll-learn-here" class="level1">
<h1>What you’ll learn here</h1>
<ol type="1">
<li><p>Acquire a general description of the analyses MAGMA allows to run at gene and gene-set levels; its purposes and applications.</p></li>
<li><p>Learn and visualize basic statistical concepts used in MAGMA.</p></li>
<li><p>Receive a more detailed demonstration of the default SNP-wise gene analysis and the competitive gene-set analysis implemented in MAGMA, showing example input and output files, and needed commands.</p></li>
<li><p>Get a much more solid idea about what MAGMA is for and how it works, which will support your future analyses and interpretations.</p></li>
</ol>
</section>
<section id="how-does-it-work" class="level1">
<h1>How does it work?</h1>
<p>MAGMA allows to first perform a gene analysis and subsequently a gene-set analysis (GSA) based on gene-level results. Note, however, that the gene-set analysis comes as a separate layer and it is an additional optional step, though it is frequently performed and quite useful.</p>
<section id="gene-analysis" class="level2">
<h2 class="anchored" data-anchor-id="gene-analysis"><strong>Gene analysis</strong></h2>
<p>Genetic markers are aggregated to the level of whole individual genes and those in a given gene are jointly tested for their association with the phenotype, defining in such way the association of the gene itself. This definitely allows to detect significant associations given by multiple small-effect markers in a gene that individually would be missed, i.e., associations that depend on multiple markers. This also reduces the number of required tests and makes the results more interpretable by summarizing at the gene level.</p>
<p>Two alternatives for gene analysis are offered by MAGMA:</p>
<section id="multiple-linear-pc-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="multiple-linear-pc-regression-model"><span style="color:#FF7256"><strong>Multiple linear PC regression model</strong></span></h3>
<p>If the input data is <strong>raw genotype data</strong>, MAGMA fits a multiple linear PC regression model to the individuals’ phenotypes. Here, for one gene <img src="https://latex.codecogs.com/png.latex?g"> at a time, the SNP matrix that contains the information of the SNPs for that gene across all the <img src="https://latex.codecogs.com/png.latex?N"> individuals studied, is projected onto its Principal Components (PCs). These PCs capture genotypic differences between individuals for the given gene and the first <img src="https://latex.codecogs.com/png.latex?K"> most explanatory ones (comprising 99.9% of the variance) are used as predictors of the phenotype (<img src="https://latex.codecogs.com/png.latex?Y">) in the linear model.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/images/MAGMA_PC_model.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin:0px" width="700"></p>
</figure>
</div>
<p>Phenotype is modeled as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY%20=%20%5Calpha_%7B0g%7D+X%5E*_%7Bg%7D%5Calpha_g+W%5Cbeta_g+%5Cepsilon_g%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%7B%5Cbegin%7Bbmatrix%7DY_1%20%5C%5C%20...%20%5C%5C%20Y_%7BN-1%7D%20%5C%5C%20Y_N%5Cend%7Bbmatrix%7D%7D%20=%20%7B%5Cbegin%7Bbmatrix%7D%5Calpha_%7B0g%7D%20%5C%5C%20...%20%5C%5C%20%5Calpha_%7B0g%7D%20%5C%5C%20%5Calpha_%7B0g%7D%5Cend%7Bbmatrix%7D%7D%20+%20%5Cstackrel%7BPC1%20%5C%20%5C%20%20%5C%20%5C%20%20%5C%20%5C%20PC2%20%5C%20%5C%20%20%5C%20%5C%20%20%5C%20%5C%20...%20%20%5C%20%5C%20%5C%20%5C%20%5C%20%5C%20PC_K%7D%20%7B%5Cbegin%7Bbmatrix%7D%20%20x_%7B11%7D%20%5C%20%5C%20x_%7B12%7D%20%5C%20%5C%20...%20%5C%20%5C%20x_%7B1K%7D%20%20%5C%5C%20%20...%20%5C%5C%20x_%7B(N-1)1%7D%20%5C%20%5C%20x_%7B(N-1)2%7D%20%5C%20%5C%20...%20%5C%20%5C%20x_%7B(N-1)K%7D%20%5C%5C%20%20x_%7BN1%7D%20%5C%20%5C%20x_%7BN2%7D%20%5C%20%5C%20...%20%5C%20%5C%20x_%7BNK%7D%20%5Cend%7Bbmatrix%7D%7D%20%7B%5Cbegin%7Bbmatrix%7D%5Calpha_%7Bg1%7D%20%5C%5C%20%20%5Calpha_%7Bg2%7D%20%5C%5C%20...%20%5C%5C%20%5Calpha_%7BgK%7D%5Cend%7Bbmatrix%7D%7D%20+%20%20%5C%5C%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cstackrel%7BCov1%20%5C%20%5C%20%20%5C%20%5C%20%20%5C%20%5C%20Cov2%20%5C%20%5C%20%20%5C%20%5C%20%20%5C%20%5C%20...%20%20%5C%20%5C%20%5C%20%5C%20%5C%20%5C%20CovL%7D%7B%5Cbegin%7Bbmatrix%7D%20%20w_%7B11%7D%20%5C%20%5C%20w_%7B12%7D%20%5C%20%5C%20...%20%5C%20%5C%20w_%7B1L%7D%20%20%5C%5C%20%20...%20%5C%5C%20w_%7B(N-1)1%7D%20%5C%20%5C%20w_%7B(N-1)2%7D%20%5C%20%5C%20...%20%5C%20%5C%20w_%7B(N-1)L%7D%20%5C%5C%20%20w_%7BN1%7D%20%5C%20%5C%20w_%7BN2%7D%20%5C%20%5C%20...%20%5C%20%5C%20w_%7BNL%7D%20%5Cend%7Bbmatrix%7D%7D%7B%5Cbegin%7Bbmatrix%7D%5Cbeta_%7Bg1%7D%20%5C%5C%20%20%5Cbeta_%7Bg2%7D%20%5C%5C%20...%20%5C%5C%20%5Cbeta_%7BgL%7D%5Cend%7Bbmatrix%7D%7D%20+%0A%7B%5Cbegin%7Bbmatrix%7D%5Cepsilon_%7Bg1%7D%20%5C%5C%20...%20%5C%5C%20%5Cepsilon_%7Bg(N-1)%7D%20%5C%5C%20%20%5Cepsilon_%7BgN%7D%5Cend%7Bbmatrix%7D%7D%0A"></p>
<p>With <img src="https://latex.codecogs.com/png.latex?X_%7Bg%7D%5E*"> the matrix of the first <img src="https://latex.codecogs.com/png.latex?K"> PCs for gene <img src="https://latex.codecogs.com/png.latex?g"> and <img src="https://latex.codecogs.com/png.latex?W"> a matrix of additional covariates for the individuals that can be included in the model. <img src="https://latex.codecogs.com/png.latex?%5Calpha_g">’s and <img src="https://latex.codecogs.com/png.latex?%5Cbeta_g">’s are the coefficients of the PCs and covariates for the gene <img src="https://latex.codecogs.com/png.latex?g">, respectively. <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_g"> is the vector of residuals and <img src="https://latex.codecogs.com/png.latex?%5Calpha_%7B0g%7D"> the intercept. The <img src="https://latex.codecogs.com/png.latex?%5Calpha_g">’s represent the effect of the genotype for gene <img src="https://latex.codecogs.com/png.latex?g"> on the phenotype (the <strong>genetic effect</strong>).</p>
<p>Then an F-test is used to assess if genotypes for gene <img src="https://latex.codecogs.com/png.latex?g"> have an effect on the phenotype under the null hypothesis that the genetic effect of <img src="https://latex.codecogs.com/png.latex?g"> on the phenotype is 0 across all PCs (<img src="https://latex.codecogs.com/png.latex?H_0:%5Calpha_g=%5Coverrightarrow%200">). This leads to a <em>p</em>-value for the association of gene <img src="https://latex.codecogs.com/png.latex?g"> with the phenotype <img src="https://latex.codecogs.com/png.latex?Y"> based on its genetic markers.</p>
<div style="background-color:#F2F2F2; padding: 15px">
<p>✔️ The advantage of using PCs instead of variables for individual SNPs is that 1) the number of variables included in the linear model is reduced and 2) they allow to account for redundancy and collinearity between SNPs. Also this model offers flexibility to accommodate additional covariates to model the phenotype.</p>
</div>
</section>
<section id="snp-wise-gene-analysis" class="level3">
<h3 class="anchored" data-anchor-id="snp-wise-gene-analysis"><span style="color:#7AC5CD"><strong>SNP-wise gene analysis</strong></span></h3>
<p>If no raw genotype data is available, MAGMA also accepts <u><strong>SNP <em>p</em>-values</strong></u> from a GWAS as input. In this case SNP <em>p</em>-values for a gene are first transformed into <u><strong>Z or</strong><img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2"><strong>statistics</strong></u> and then combined into a <u><strong>gene test-statistic</strong></u> by the <span style="background-color: #F0FFF0"><strong>mean SNP statistic</strong></span> or <span style="background-color:#FFF0F5"><strong>top SNP statistic</strong></span> method. This gene test-statistic is then used to compute the <u><strong>gene <em>p</em>-value</strong></u>, either by an approximation of the sampling distribution (mean SNP statistic method) or by phenotype permutation (mean and top SNP statistic methods).</p>
<p>This SNP-wise MAGMA analysis based on SNP summary statistics requires a <strong>reference dataset</strong> with similar ancestry as the data from which SNPs <em>p</em>-values were computed. This is needed to account for linkage disequilibrium (LD) between SNPs. If an approximation of the sampling distribution is used to compute the gene <em>p</em>-value, this reference is required to obtain the SNP statistic correlation matrix <img src="https://latex.codecogs.com/png.latex?R">. If phenotype permutation is chosen, these reference data are necessary to generate the gene test-statistics empirical sampling distribution.</p>
<div style="background-color:#F2F2F2; padding: 15px; margin-bottom:0px">
<div class="line-block">Summary: SNP <em>p</em>-values → SNP statistics →<span style="color:#EE00EE"><strong>*</strong></span> gene test-statistic →<span style="color: #00CD00"><strong>*</strong></span> gene <em>p</em>-value → gene <em>z</em>-score (<img src="https://latex.codecogs.com/png.latex?z_g">)</div>
</div>
<p><span style="color:#EE00EE"><strong>*</strong></span>Gene test-statistics can be constructed from the SNP statistics applying one of the two implemented methods in MAGMA:</p>
<ul>
<li><p><span style="background-color: #F0FFF0"><strong>Mean SNP statistic</strong></span>:</p>
<ul>
<li><p><strong>Mean Z gene test-statistic</strong>: SNP <em>p</em>-values of a gene are transformed to Z-statistics and the mean (weighted or unweighted sum) of such Z-stats is used as the test-statistic of the gene: <img src="https://latex.codecogs.com/png.latex?T=%5Csum_i%5EG%20w_iz_i">, with <img src="https://latex.codecogs.com/png.latex?G"> the total number of SNPs in the gene and <img src="https://latex.codecogs.com/png.latex?z_i"> and <img src="https://latex.codecogs.com/png.latex?w_i"> the Z-statistic and weight for SNP <img src="https://latex.codecogs.com/png.latex?i">, respectively. These gene test-stats follow a normal distribution.</p></li>
<li><p><strong>Mean</strong> <img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2"> <strong>gene test-statistic</strong>: the mean (weighted or unweighted sum) of the <img src="https://latex.codecogs.com/png.latex?-2log"> of the SNP <em>p</em>-values (that are <img src="https://latex.codecogs.com/png.latex?%5Csim%5Cchi%5E2_%7B(2)%7D">) is used as gene test-statistic: <img src="https://latex.codecogs.com/png.latex?T=-2%5Csum_i%5EG%20w_i%5Clog(p_i)">, with <img src="https://latex.codecogs.com/png.latex?p_i"> the <em>p</em>-value of SNP <img src="https://latex.codecogs.com/png.latex?i">. These gene test-stats are assumed to be <img src="https://latex.codecogs.com/png.latex?%5Csim%20c%5Cchi%5E2_%7B(f)%7D">, where <img src="https://latex.codecogs.com/png.latex?c"> and <img src="https://latex.codecogs.com/png.latex?f"> are constants of the distribution.</p></li>
</ul>
<p><span style="color: #00CD00"><strong>*</strong></span>For both mean Z and mean <img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2"> gene test-statistics the <em>p</em>-value of the gene is obtained based on a known <strong>approximation of the sampling distribution</strong> of the gene test-stats. For such purposes, the reference dataset is needed to estimate the SNP statistic correlation matrix, from which the optional SNP weights (<img src="https://latex.codecogs.com/png.latex?w_i">) are computed to correct for dependency between SNPs. A phenotype permutation procedure can also be applied to compute empirical gene <em>p</em>-values (see further below).</p></li>
<li><p><span style="background-color:#FFF0F5"><strong>Top SNP statistic(s)</strong></span>: the lowest SNP <em>p</em>-value among all SNPs in the gene (corresponding to the most associated SNP) or the sum of the <img src="https://latex.codecogs.com/png.latex?-log(p)"> for the top most associated SNPs is used as the gene test-statistic.</p>
<p><span style="color: #00CD00"><strong>*</strong></span>To compute the gene <em>p</em>-value a <strong>phenotype permutation</strong> procedure is the only option available. Here random phenotypes are assigned to the reference data and a top gene test-statistic is computed in each permutation. The empirical gene <em>p</em>-value is computed as the proportion of these permuted gene test-statistics that are higher than the observed one.</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The SNP-wise gene analysis of MAGMA can also be run with raw genotype data, in which case SNP <em>p</em>-values are computed internally and the raw genotype data takes place of the reference data.</p>
</div>
</div>
<p>After running the gene analysis, either by PC regression or SNP-wise analysis, the resulting gene <em>p</em>-values are subsequently transformed to <u><strong>Z-values (</strong><img src="https://latex.codecogs.com/png.latex?z_g"><strong>)</strong></u> to be introduced into the gene-set analysis. These Z-values are normally distributed and capture the <strong>association</strong> <strong>strength</strong> of the genes with the phenotype: the greater (higher positive) they are the stronger the gene association.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that with both PC regression and SNP-wise models we are not really looking at the sign (+/-) of the association of the genetic markers of a gene with the phenotype, just exploring if there’s an association at all:</p>
<ul>
<li><p>In the PC regression model, we only assess if all genetic effects of a gene (<img src="https://latex.codecogs.com/png.latex?%5Calpha_g">’s) are zero or not, but not if the global gene effect is positive or negative.</p></li>
<li><p>With SNP-wise methods, since they are based on SNP <em>p</em>-values that don’t inform about the sign of the association, just how strong it is, the gene test-stats derived from them are also reflecting “sign-ignorant” associations. The gene <em>p</em>-value, however, is computed based on the right tail of the distribution of these gene test-stats (<img src="https://latex.codecogs.com/png.latex?T">’s) as they correspond to stronger (but not necessarily positive) associations.</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/images/T_distribution_transp.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin:0px" width="271"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="gene-set-analysis" class="level2">
<h2 class="anchored" data-anchor-id="gene-set-analysis"><strong>Gene-set analysis</strong></h2>
<p>Once having gene-level associations, we can now think of gene-set associations. Initially, we aggregate genes in groups of genes that share cellular or functional properties, such as involvements in certain biological processes, with particular molecular functions, cellular locations, cell-type specific expression or activity, or differential expression for a given condition. These define concrete processes or features we may be interested in relating with a GWAS phenotype. By doing this, we can gain insights into the potential molecules, pathways, and tissues implicated in a phenotype’s etiology.</p>
<p>Since all that’s necessary from the gene analysis to run the gene-set analysis are the gene Z-values, gene-set analysis operates the same independently of the gene analysis method applied (PC regression or SNP-wise), as both result in gene <em>p</em>-values and respective <img src="https://latex.codecogs.com/png.latex?z_g">’s.</p>
<p>Two gene-level regression models are implemented to asses the association of gene-sets with the phenotype:</p>
<section id="self-contained-analysis" class="level3">
<h3 class="anchored" data-anchor-id="self-contained-analysis"><span style="color:#8FBC8F"><strong>Self-contained analysis</strong></span></h3>
<p>Tests if the genes of a gene set <img src="https://latex.codecogs.com/png.latex?s"> are jointly associated with the phenotype. This is assessed by an intercept-only linear regression <img src="https://latex.codecogs.com/png.latex?Z_s=%5Cbeta_0%5Coverrightarrow1+%5Cepsilon_s">, with <img src="https://latex.codecogs.com/png.latex?Z_s"> the variable with the <img src="https://latex.codecogs.com/png.latex?z_g">’s of the genes in <img src="https://latex.codecogs.com/png.latex?s">. With this simple model we evaluate the null <img src="https://latex.codecogs.com/png.latex?H_0:%5Cbeta_0=0"> against the alternative <img src="https://latex.codecogs.com/png.latex?H_A:%20%5Cbeta_0%3E0">. This is equivalent to a one-sided single-sample <em>t</em>-test comparing the mean association of genes in <img src="https://latex.codecogs.com/png.latex?s"> to 0. In other words, we are evaluating if the mean association strength of the genes in the set is greater than 0 (i.e., if it is a strong association, not to be confused with a positive effect of <img src="https://latex.codecogs.com/png.latex?s"> on the phenotype).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/images/GSA_self_contained.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin:0px" width="378"></p>
</figure>
</div>
</section>
<section id="competitive-analysis" class="level3">
<h3 class="anchored" data-anchor-id="competitive-analysis"><span style="color:#CD9B9B"><strong>Competitive analysis</strong></span></h3>
<p>Tests whether the genes in the set <img src="https://latex.codecogs.com/png.latex?s"> are more strongly associated with the phenotype than the rest of genes not in the set. Here the outcome variable <img src="https://latex.codecogs.com/png.latex?Z"> of the model now includes the <img src="https://latex.codecogs.com/png.latex?z_g"> of all genes. We define <img src="https://latex.codecogs.com/png.latex?S_s"> as a binary predictor of <img src="https://latex.codecogs.com/png.latex?Z"> that equals 1 if a gene is in <img src="https://latex.codecogs.com/png.latex?s"> and 0 if not: <img src="https://latex.codecogs.com/png.latex?Z=%5Cbeta_%7B0s%7D%5Coverrightarrow1+S_s%5Cbeta_s+%5Cepsilon"></p>
<p>Here <img src="https://latex.codecogs.com/png.latex?%5Cbeta_s"> reflects the difference in the association strength of the genes in <img src="https://latex.codecogs.com/png.latex?s"> versus those not in <img src="https://latex.codecogs.com/png.latex?s">. The <em>p</em>-value of the gene set results from testing on <img src="https://latex.codecogs.com/png.latex?%5Cbeta_s">: we test <img src="https://latex.codecogs.com/png.latex?H_0:%20%5Cbeta_s=0"> vs <img src="https://latex.codecogs.com/png.latex?H_A:%20%5Cbeta_s%3E0">, which is equivalent to a one-sided two-sample <em>t</em>-test evaluating if the mean association strength of genes in <img src="https://latex.codecogs.com/png.latex?s"> is greater than the mean association strength of genes not in <img src="https://latex.codecogs.com/png.latex?s">. But again, this doesn’t mean genes in the set <img src="https://latex.codecogs.com/png.latex?s"> have a positive association with the phenotype. This analysis is performed by default.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/images/GSA_competitive.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin:0px" width="228"></p>
</figure>
</div>
<div style="background-color:#F2F2F2; padding: 15px">
<p>✔️ Both self-contained and competitive gene-set analyses are implemented through more general gene-level regression models that can accommodate combinations of gene sets and gene properties such as gene expression levels and gene size to test for their effects and correct for potential confounding effects. This can be useful, for example, to test if variables such as differential expression between tissues (🧠 vs 🩸) or conditions (⚕️vs 💊) have an effect on the phenotype.</p>
<p>Further, analyzing gene sets evidently reduces the number of output tests, but note that one test per gene still has to be performed in the the previous gene analysis.</p>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Due to LD between SNPs neighboring genes are usually correlated. This obligate us to assume <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%20%5Csim%20MVN(%5Coverrightarrow0,%20%5Csigma%5E2R)"> in the gene-set analysis, where <img src="https://latex.codecogs.com/png.latex?R"> is the <strong>gene-gene correlation matrix</strong>.</p>
</div>
</div>
</section>
</section>
</section>
<section id="example-of-snp-wise-gene-analysis-and-competitive-gene-set-analysis" class="level1">
<h1>Example of SNP-wise gene analysis and competitive gene-set analysis</h1>
<p>By default the SNP-wise gene analysis method implemented is the mean Z gene test-statistic, and the default gene-set analysis is the competitive one. Let’s exemplify how to run these analyses. The following are the three main steps implemented in MAGMA.</p>
<section id="step-1-annotation-of-snps-onto-genes" class="level2">
<h2 class="anchored" data-anchor-id="step-1-annotation-of-snps-onto-genes">Step 1: Annotation of SNPs onto genes</h2>
<p>The first step is to map all SNPs from your GWAS data onto the genes of the reference genome.</p>
<ul>
<li><p><strong>Input</strong>: we need SNP and gene positions based on <span style="background-color: #FFF68F">the same human genome reference build</span>; we provide this in the&nbsp;<code>.snploc</code>&nbsp;and in the&nbsp;<code>.gene.loc</code>&nbsp;files, respectively. <a href="https://cncr.nl/research/magma/">MAGMA website</a> provides gene location files ready to download.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .snploc file example</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Columns: </span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * SNP: SNP rsID</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * CHR: SNP chromosome</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * BP:  SNP position</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">       <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SNP</span> CHR         BP </span>
<span id="cb1-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs62513865</span>   8  101592213 </span>
<span id="cb1-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs79643588</span>   8  106973048 </span>
<span id="cb1-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs17396518</span>   8  108690829 </span>
<span id="cb1-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs983166</span>     8  108681675 </span>
<span id="cb1-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs28842593</span>   8  103044620 </span>
<span id="cb1-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs7014597</span>    8  104152280 </span>
<span id="cb1-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs3134156</span>    8  100479917 </span>
<span id="cb1-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs6980591</span>    8  103144592 </span>
<span id="cb1-16"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs72670434</span>   8  108166508</span></code></pre></div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .gene.loc file example</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Required columns: </span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * GeneID</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Chr</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Start site</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Stop site</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000243485</span> 1 29554 31109 + MIR1302-2HG </span>
<span id="cb2-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000186092</span> 1 65419 71585 + OR4F5 </span>
<span id="cb2-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000238009</span> 1 89295 133723 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> AL627309.1 </span>
<span id="cb2-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000239906</span> 1 139790 140339 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> AL627309.2 </span>
<span id="cb2-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000236601</span> 5 180881343 180888537 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> AL732372.1 </span>
<span id="cb2-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000235146</span> 1 523009 530148 + AC114498.1 </span>
<span id="cb2-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000229905</span> 1 696291 697369 + AL669831.2 </span>
<span id="cb2-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000237491</span> 1 714150 745440 + AL669831.5</span></code></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>SNPs in sexual chromosomes are usually excluded from the analysis as their inclusion brings additional analytical, statistical, and bioinformatic challenges for their analysis <span class="citation" data-cites="sun2023">(Sun et al. 2023)</span>. MAGMA only supports X chromosome analysis.</p>
</div>
</div></li>
<li><p><strong>Commands</strong>: the following are the flags and inputs used to map the SNPs onto genes.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Run SNP annotation</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --annotate: flag to run annotation </span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --snp-loc: indicate file with SNP positions</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --gene-loc: indicate file with gene positions</span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --out: prefix for output files</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">magma</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--annotate</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb3-8">      <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--snp-loc</span> [.snploc file]<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb3-9">      <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--gene-loc</span> [gene.loc file]<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb3-10">      <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--out</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">output_prefix</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></li>
<li><p><strong>Output</strong>: this step returns the <code>.genes.annot</code> file as output, containing all SNPs that were assigned to each gene.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .genes.annot file example</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Columns: </span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * GeneID</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Chr:Start:Stop</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Corresponding gene SNP rsIDs</span></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">window_up</span> = 0 </span>
<span id="cb4-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">window_down</span> = 0 </span>
<span id="cb4-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000237491</span> 1:714150:745440 rs186002080 rs12184267 rs142557973 rs149887893 </span>
<span id="cb4-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000177757</span> 1:752751:755217 rs3115859 rs3131968 rs3131967 rs3115860 </span>
<span id="cb4-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000225880</span> 1:761586:762902 rs2286139 rs377377186 rs374493323 </span>
<span id="cb4-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000230368</span> 1:803451:812283 rs11240779 rs28410559 rs72631880 rs58686784 </span></code></pre></div></li>
</ul>
</section>
<section id="step-2-snp-wise-gene-analysis" class="level2">
<h2 class="anchored" data-anchor-id="step-2-snp-wise-gene-analysis">Step 2: SNP-wise gene analysis</h2>
<ul>
<li><p><strong>Input</strong>: we need to provide the SNP <em>p</em>-values in a <code>.pval</code> file and the gene-wise SNPs in the <code>.genes.annot</code> file obtained in the previous step. A reference dataset must be provided as well. Check available options of reference data files in the <a href="https://cncr.nl/research/magma/">MAGMA website</a>.</p>
<p>The total sample size (N) of the GWAS from which the SNP <em>p</em>-values were derived must be indicated as well using the <em>N</em> modifier of <code>--pval</code>. Alternatively, if different sample sizes were used per SNP, these can be contained in a separate column of the <code>.pval</code> file whose name is specified in the <em>ncol</em> modifier of <code>--pval</code>.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .pval file example</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Columns: </span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * SNP: SNP ID</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * P: SNP p-value</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * N: optional SNP sample size </span></span>
<span id="cb5-6"></span>
<span id="cb5-7">       <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SNP</span>      P      N </span>
<span id="cb5-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs62513865</span> 0.4847 130644 </span>
<span id="cb5-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs79643588</span> 0.5605 130644 </span>
<span id="cb5-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs17396518</span> 0.8145 130644 </span>
<span id="cb5-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs983166</span>   0.5704 130644 </span>
<span id="cb5-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs28842593</span> 0.7488 130644 </span>
<span id="cb5-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs7014597</span>  0.5034 130644 </span>
<span id="cb5-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rs3134156</span>  0.2225 130644</span></code></pre></div>
<p>The next is a <code>head</code> of the 1000 Genomes European panel data used as the reference dataset.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## g1000_eur reference data example</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Columns: </span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Chr</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * SNP rsID</span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Genetic distance </span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Position</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Allele1</span></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Allele2</span></span>
<span id="cb6-9"></span>
<span id="cb6-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span> rs537182016 0 10539 A C </span>
<span id="cb6-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span> rs575272151 0 11008 G C </span>
<span id="cb6-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span> rs544419019 0 11012 G C </span>
<span id="cb6-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span> rs540538026 0 13110 A G </span>
<span id="cb6-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span> rs62635286  0 13116 G T </span>
<span id="cb6-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span> rs200579949 0 13118 G A </span></code></pre></div></li>
<li><p><strong>Commands</strong>: the following are the flags and files required to run the SNP-wise mean Z-stats method.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Run gene analysis based on SNP p-values</span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --bfile: indicate reference dataset</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --pval: indicate file with SNP p-values</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                       ncol: colname for SNP samples sizes in .pval file</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#    (or alternatively) N: integer for total sample size of study</span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --gene-annot: indicate file with gene SNPs</span></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --out: prefix for output files</span></span>
<span id="cb7-8"></span>
<span id="cb7-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">magma</span> </span>
<span id="cb7-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--bfile</span> [reference file]<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb7-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--pval</span> [.pval file] ncol=[colname for N]<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb7-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--gene-annot</span> [.genes.annot file]<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb7-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--out</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">output_prefix</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div></li>
<li><p><strong>Output</strong>: the output of the gene analysis are the gene <em>p</em>-values and the gene <img src="https://latex.codecogs.com/png.latex?z_g">’s. Also returned is the gene correlation matrix <img src="https://latex.codecogs.com/png.latex?R"> used to account for LD in the gene-set analysis (step 3).</p>
<p>Two files are returned as output: the <code>.genes.out</code> file that contains the gene analysis results in a human-readable format and the <code>.genes.raw</code> file that is an intermediary file input for gene-set analysis that also includes the gene correlations.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .genes.out output file example</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * NSNPS: number of SNPs assigned to each gene </span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * NPARAM: number of relevant parameters (such as PCs) used in the model for each gene </span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * N: sample size for analyzing the gene </span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * ZSTAT: gene z-value </span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * P: gene p-value </span></span>
<span id="cb8-7"></span>
<span id="cb8-8">           <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">GENE</span> CHR  START   STOP NSNPS NPARAM      N    ZSTAT       P </span>
<span id="cb8-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000237491</span>   1 714150 745440    16      5 104688 0.59488  0.27596 </span>
<span id="cb8-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000177757</span>   1 752751 755217    11      2 114792 0.22362  0.41153 </span>
<span id="cb8-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000225880</span>   1 761586 762902     2      1 110271 0.18366  0.42714 </span>
<span id="cb8-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000230368</span>   1 803451 812283    10      3 120884 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-1.2421</span>   0.8929 </span>
<span id="cb8-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000272438</span>   1 840214 851356    32      4 116196  1.1083  0.13386 </span>
<span id="cb8-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000223764</span>   1 852245 856396    17      3 116843  1.2828 0.099786 </span></code></pre></div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .genes.raw output file example</span></span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">VERSION</span> = 110 </span>
<span id="cb9-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">COVAR</span> = NSAMP MAC </span>
<span id="cb9-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000237491</span> 1 714150 745440 16 5 104688 63.625 0.594875 </span>
<span id="cb9-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000177757</span> 1 752751 755217 11 2 114792 103 0.223624 0.772254 </span>
<span id="cb9-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000225880</span> 1 761586 762902 2 1 110271 87 0.183658 0.825082 0.943709 </span>
<span id="cb9-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000230368</span> 1 803451 812283 10 3 120884 106.7 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-1.24209</span> 0.220645 0.404423 0.341011 ENSG00000272438 1 840214 851356 32 4 116196 212.625 1.10832 0.0435105 0.0410553 0.0368872</span></code></pre></div></li>
</ul>
</section>
<section id="step-3-competitive-gene-set-analysis" class="level2">
<h2 class="anchored" data-anchor-id="step-3-competitive-gene-set-analysis">Step 3: Competitive gene-set analysis</h2>
<ul>
<li><p><strong>Input</strong>: this analysis takes the <img src="https://latex.codecogs.com/png.latex?z_g"> for each gene obtained in the previous step (in the <code>.genes.raw</code> file) and the gene sets of interest.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## gene_sets.txt file example</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Columns:</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Gene: gene ID</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * Set: set to which the gene belongs</span></span>
<span id="cb10-5"></span>
<span id="cb10-6">           <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Gene</span>   Set </span>
<span id="cb10-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000164647</span>  SetA </span>
<span id="cb10-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000105889</span>  SetA </span>
<span id="cb10-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000085117</span>  SetA </span>
<span id="cb10-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000071794</span>  SetA </span>
<span id="cb10-11">      <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span>         ...</span>
<span id="cb10-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000135535</span>  SetF </span>
<span id="cb10-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000183230</span>  SetF </span>
<span id="cb10-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENSG00000124493</span>  SetF</span></code></pre></div></li>
<li><p><strong>Commands</strong>:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Competitive GSA </span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --gene-results: indicate file with gene z-values</span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --set-annot: indicate file with gene sets</span></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#               gene-col: colname for genes   </span></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#               set-col:  colname for sets</span></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  --out: name of output folder</span></span>
<span id="cb11-7"></span>
<span id="cb11-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">magma</span> </span>
<span id="cb11-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--gene-results</span> [.genes.raw file]<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\ </span></span>
<span id="cb11-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--set-annot</span> [gene_sets.txt file] </span>
<span id="cb11-11">            <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gene-col=Gene</span> </span>
<span id="cb11-12">            <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">set-col=Set\ </span></span>
<span id="cb11-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">--out</span> [output folder]</span></code></pre></div></li>
<li><p><strong>Output</strong>: the file <code>.gsa.out</code> contains the primary results of the competitive gene-set analysis.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode Bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## .gsa.out output file example</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * VARIABLE: gene set name </span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * TYPE: type of variable (set) </span></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * NGENES: size of overlap between our genes in the set and genes with assigned SNPs</span></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#            (i.e. number of genes in the set with SNPs) </span></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * BETA: regression coeff (Bs) for Ss </span></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * BETSA_STD: semi-standarized regression coeff. </span></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#               This is the predicted change in Z by a change of one sd in the </span></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#               predictor gene set (i.e., Bs/sd(Ss)) </span></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * SE: standard error of Bs</span></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  * P: p-value for the set </span></span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">TOTAL_GENES</span> = 28129  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Total number of genes included in the analysis </span></span>
<span id="cb12-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">TEST_DIRECTION</span> = one-sided, positive <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> two-sided <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">covar</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## one-sided (+) test for GSA </span></span>
<span id="cb12-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">CONDITIONED_INTERNAL</span> = gene size, gene density, sample size, inverse mac, log<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gene</span> size<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> log<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">gene</span> density<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> log<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">sample</span> size<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> log<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">inverse</span> mac<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Variables the analysis was conditioned on </span></span>
<span id="cb12-16"></span>
<span id="cb12-17"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">VARIABLE</span> TYPE NGENES      BETA  BETA_STD        SE      P </span>
<span id="cb12-18">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SetA</span>  SET   2557  0.045582  0.013104  0.020419 0.0128 </span>
<span id="cb12-19">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SetB</span>  SET    395  0.071821  0.008451  0.051418 0.081242 </span>
<span id="cb12-20">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SetC</span>  SET    850 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-0.039813</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-0.0068155</span> 0.034848 0.87337 </span>
<span id="cb12-21">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SetD</span>  SET    163  0.033361  0.0025322 0.079059 0.33652 </span>
<span id="cb12-22">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SetE</span>  SET   1709  0.083787  0.020016  0.02423  0.00027251 </span>
<span id="cb12-23">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">SetF</span>  SET    232  0.099547  0.0090033 0.067531 0.0702</span></code></pre></div></li>
</ul>
<p>The <code>.gsa.sets.genes.out</code> file provides per-gene information for each gene set. The <img src="https://latex.codecogs.com/png.latex?z_g">’s used for the analysis are shown in this file and in <code>.gsa.genes.out</code> that has information for all genes in the analysis.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here <code>NGENES</code> doesn’t always match the number of genes provided for a set. That’s because these genes must 1) exist in the <code>.gene.loc</code> file in order to be assigned SNPs, and 2) have SNPs present in the GWAS study and in the reference data as only the ones included in this latter file are used. This is because only genes with SNP <em>p</em>-values can be assigned a <img src="https://latex.codecogs.com/png.latex?z_g"> and consequently be introduced into the gene-set analysis (see schematic representation below).</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>There must be an overlap &gt;1 between genes in the set and genes with assigned SNPs (i.e.&nbsp;<code>NGENES</code> &gt;1) to yield results. Otherwise MAGMA can’t perform the GSA and returns <span style="color: gray"><code>NA</code></span>.</p>
</div>
</div>
<p>A visual representation of these three steps:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/images/MAGMA_steps.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="margin:0px"></p>
</figure>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>MAGMA is a powerful computational tool for extensible and adaptable gene and gene-set analyses. As presented here, MAGMA offers multiple input options that further increase its applicability. Of outmost utility is the gene analysis SNP-wise alternatives that only utilize SNP summary statistics, given that raw genotype data are not always available or accessible. This opens up the possibility to analyze a wider range of GWASes results in a fast and interpretable manner. Additionally, by relying on individual- and gene-level multiple linear regression models, MAGMA enables to analyze any discrete and continuous covariates describing individuals’ features and gene properties in the gene and gene-set analysis, respectively.</p>
<p>The power of this framework has proven itself, placed as one of the main methods to analyze GWAS data. Now that you know how it works, I bet you can imagine the number of hypotheses you can test by evaluating the association between any phenotype for which GWAS/genotype data are available and any set of genes with common characteristics of clinical or biological interest.</p>
</section>
<section id="relevant-links-and-bibliography" class="level1">
<h1>Relevant links and bibliography</h1>
<div style="background-color: #F8F8FF;  padding: 14px; margin-left: 0px; margin-bottom: 1px; font-size: 15px; line-height: 1.3; margin-bottom:15px">
<div class="line-block">📑 <strong>Original publication for MAGMA:</strong><br>
de Leeuw, C. A., Mooij, J. M., Heskes, T., &amp; Posthuma, D. (2015). MAGMA: generalized gene-set analysis of GWAS data.&nbsp;<em>PLoS computational biology</em>,&nbsp;<em>11</em>(4), e1004219. <a href="https://doi.org/10.1371/journal.pcbi.1004219https://doi.org/10.1371/journal.pcbi.1004219">https://doi.org/10.1371/journal.pcbi.1004219</a></div>
</div>
<div style="background-color: #F8F8FF;  padding: 14px; margin-left: 0px; margin-bottom: 1px; font-size: 15px; line-height: 1.3; margin-bottom:15px">
<div class="line-block">📁 <strong>Supplemental Methods for MAGMA:</strong><br>
de Leeuw, C. A., Mooij, J. M., Heskes, T., &amp; Posthuma, D. (2015). MAGMA: generalized gene-set analysis of GWAS data.&nbsp;<em>PLoS computational biology</em>,&nbsp;<em>11</em>(4, Suppl.), e1004219. Available here: <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004219#sec016" class="uri">https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004219#sec016</a></div>
</div>
<div style="background-color: #F8F8FF;  padding: 14px; margin-left: 0px; margin-bottom: 1px; font-size: 15px; line-height: 1.3; margin-bottom:15px">
<div class="line-block">📓 <strong>MAGMA manual (version 1.09):</strong><br>
Available here: <a href="https://ibg.colorado.edu/cdrom2021/Day10-posthuma/magma_session/manual_v1.09a.pdf" class="uri">https://ibg.colorado.edu/cdrom2021/Day10-posthuma/magma_session/manual_v1.09a.pdf</a></div>
</div>
<div style="background-color: #F8F8FF;  padding: 14px; margin-left: 0px; margin-bottom: 1px; font-size: 15px; line-height: 1.3; margin-bottom:15px">
<div class="line-block">🔎 <strong>MAGMA website:</strong><br>
Available here: <a href="https://cncr.nl/research/magma/" class="uri">https://cncr.nl/research/magma/</a></div>
</div>
<p>Contents of this post are based on the original MAGMA publication and Supplementary Methods, as well as on its official documentation sites (links shown above).</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-sun2023" class="csl-entry">
Sun, Lei, Zhong Wang, Tianyuan Lu, Teri A. Manolio, and Andrew D. Paterson. 2023. <span>“eXclusionarY: Ten Years Later, Where Are the Sex Chromosomes in GWAS?”</span> <a href="http://dx.doi.org/10.1101/2023.02.03.526992">http://dx.doi.org/10.1101/2023.02.03.526992</a>.
</div>
</div></section></div> ]]></description>
  <category>GWAS</category>
  <category>Gene Analysis</category>
  <category>Gene Set Analysis</category>
  <category>SNP summary statistics</category>
  <guid>https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/</guid>
  <pubDate>Mon, 15 Jul 2024 23:00:00 GMT</pubDate>
  <media:content url="https://daianna21.github.io/daianna_blog/posts/2024-07-16-MAGMA/images/MAGMA_logo.png" medium="image" type="image/png" height="76" width="144"/>
</item>
</channel>
</rss>
